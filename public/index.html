<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaza Protocol - Family Connect</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Asap+Condensed:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Hide spin buttons for number inputs */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen bg-gray-100">
        <!-- Navy Header Bar -->
        <div class="w-full bg-[#3274B5] text-white h-20 flex items-center pl-4 pr-2 md:pl-[37px] md:pr-[11px] shadow-md relative">
            <div class="text-3xl md:text-4xl whitespace-nowrap" style="font-family: 'Asap Condensed', sans-serif; letter-spacing: 0.03em;">[D|H<span style="letter-spacing: calc(0.03em + 1px)">|S]</span></div>
            <div class="ml-3 md:ml-6 text-sm opacity-90 font-light border-l border-white/30 pl-3 md:pl-6 h-16 flex flex-col justify-center">
                <div class="font-bold text-[9px] md:text-xs leading-tight md:leading-none mb-[3.5px] whitespace-nowrap tracking-tight">[72H] ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ŸÖÿ¨ŸÖŸàÿπÿ© ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± | Test Group Login</div>
                <div class="font-bold text-[10px] leading-none">System Active | v2.4.0</div>
            </div>
            <button v-if="profile.email" @click="signOut" class="absolute bottom-[9px] right-[20.5px] md:right-[40px] text-white hover:text-gray-200 text-[8px] border border-white px-2 py-0 rounded transition flex items-center justify-center gap-1 h-[18px]">
                <span class="text-[10px] leading-none pb-[2px]">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨</span>
            </button>
        </div>

        <div class="flex flex-col items-center justify-start p-4 pt-3" style="min-height: calc(100vh - 7rem);">
        
        <!-- Mobile User Bar (Aligned with Card) -->
        <div class="max-w-2xl w-full flex justify-between items-end mb-3 px-1" v-if="profile.email">
            <div class="flex items-center gap-2 mb-[3px]">
                <img v-if="profile.profile_pic_url" :src="profile.profile_pic_url" class="w-8 h-8 rounded-full border border-gray-300 object-cover">
                <div v-else class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-xs font-bold text-gray-600">
                    {{ (profile.name || profile.family_name || 'F')[0].toUpperCase() }}
                </div>
                <div class="text-xs font-bold text-gray-700">{{ profile.name || profile.family_name || profile.email }}</div>
            </div>
            <div class="grid grid-cols-[auto_auto_auto] text-[9px] text-[#3274B5] leading-tight items-baseline">
                <span class="text-right text-[10px]">ÿ™ÿπŸÑŸäŸÇÿßÿ™ ÿßŸÑÿ∞ŸÉÿßÿ°</span>
                <span class="text-left text-[8px] pl-1">AI Comments</span>
                <span class="font-mono text-right pl-[19px]">{{ profile.comments_count || 0 }}</span>

                <span class="text-right text-[10px]">ÿ±ÿ≥ÿßÿ¶ŸÑ ŸÖÿ±ÿ≥ŸÑÿ©</span>
                <span class="text-left text-[8px] pl-1">DMs Sent</span>
                <span class="font-mono text-right pl-[19px]">{{ profile.dms_count || 0 }}</span>

                <span class="text-right text-[10px]">ÿ±ŸäŸÑÿ≤ ŸÖŸÜÿ¥ÿ£ÿ©</span>
                <span class="text-left text-[8px] pl-1">Reels Created</span>
                <span class="font-mono text-right pl-[19px]">{{ profile.reels_count || 0 }}</span>

                <span class="text-right text-[10px]">ÿ£ŸäÿßŸÖ ÿßŸÑŸÜÿ¥ÿßÿ∑</span>
                <span class="text-left text-[8px] pl-1">Active Days</span>
                <span class="font-mono text-right pl-[19px]">{{ getRunningTime() }}</span>
            </div>
        </div>

        <div class="max-w-2xl w-full bg-white rounded-lg shadow-lg p-4 md:p-8">
            
            <!-- Header -->
            <div class="text-center mb-[29px]">
                <h1 class="text-xl text-[#3274B5] uppercase tracking-wide leading-none" style="font-family: 'Oswald', sans-serif;">Test Group Portal</h1>
                <p class="text-gray-500 text-xs uppercase mt-[2px]" style="font-family: 'Roboto Mono', monospace; letter-spacing: 0.18em;">Secure Environment</p>
            </div>

            <!-- Success State -->
            <div v-if="step === 'success'" class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                    <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900">Connected Successfully</h3>
                <p class="text-sm text-gray-500 mt-2">Your account is now linked securely. You can close this page.</p>
            </div>

            <!-- Portal Login -->
            <div v-if="step === 'portal_login'" class="w-full max-w-[350px] mx-auto">
                <div class="flex border-b border-[#3274B5] mb-6">
                    <button @click="authMode = 'register'" :class="{'border-b-2 border-[#3274B5] font-bold': authMode === 'register'}" class="flex-1 pt-2 pb-[11px] text-gray-600 text-sm text-left">1. Register | ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ¨ÿØŸäÿØ</button>
                    <div class="w-px h-5 bg-[#3274B5] self-center"></div>
                    <button @click="authMode = 'login'" :class="{'border-b-2 border-[#3274B5] font-bold': authMode === 'login'}" class="flex-1 pt-2 pb-[11px] text-gray-600 text-sm text-right">2. Login | ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</button>
                </div>

                <form @submit.prevent="authMode === 'login' ? handlePortalLogin() : handlePortalRegister()">
                    <div v-if="authMode === 'register'" class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Family Name | ÿßÿ≥ŸÖ ÿßŸÑÿπÿßÿ¶ŸÑÿ©</label>
                        <input v-model="form.family_name" type="text" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="e.g. Al-Masri Family | ŸÖÿ´ÿßŸÑ: ÿπÿßÿ¶ŸÑÿ© ÿßŸÑŸÖÿµÿ±Ÿä">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Email Address | ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</label>
                        <input v-model="form.email" type="email" pattern="[^@\s]+@[^@\s]+\.[^@\s]+" title="Must be a valid email address" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="family@example.com">
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Password | ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</label>
                        <input v-model="form.password" type="password" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div v-if="authMode === 'login'" class="mb-6 text-right">
                        <button type="button" @click="step = 'forgot_password'" class="text-xs text-[#3274B5] hover:underline">Forgot Password? | ŸÜÿ≥Ÿäÿ™ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±ÿü</button>
                    </div>
                    <button :disabled="loading" type="submit" class="w-auto px-4 mx-auto block bg-[#3274B5] text-white font-bold py-2 rounded-lg hover:bg-[#285e94] transition flex justify-center items-center text-sm gap-1">
                        <span v-if="!loading && authMode === 'login'" class="flex items-center gap-1">Enter Portal | <span class="text-base">ÿØÿÆŸàŸÑ</span></span>
                        <span v-if="!loading && authMode === 'register'" class="flex items-center gap-1">Create Account | <span class="text-base">ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®</span></span>
                        <div v-if="loading" class="loader"></div>
                    </button>
                </form>
            </div>

            <!-- Forgot Password -->
            <div v-if="step === 'forgot_password'" class="w-full max-w-[350px] mx-auto">
                <h3 class="text-lg font-bold text-center mb-4">Reset Password</h3>
                <p class="text-sm text-gray-600 mb-6 text-center">Enter your email address and we'll send you a link to reset your password.</p>
                <form @submit.prevent="handleForgotPassword">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Email Address</label>
                        <input v-model="form.email" type="email" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <button :disabled="loading" type="submit" class="w-full bg-[#3274B5] text-white font-bold py-2 rounded-lg hover:bg-[#285e94] transition flex justify-center items-center text-sm mb-4">
                        <span v-if="!loading">Send Reset Link</span>
                        <div v-else class="loader"></div>
                    </button>
                    <button type="button" @click="step = 'portal_login'" class="w-full text-gray-500 text-sm">Back to Login</button>
                </form>
            </div>

            <!-- Reset Password (New Password Input) -->
            <div v-if="step === 'reset_password'" class="w-full max-w-[350px] mx-auto">
                <h3 class="text-lg font-bold text-center mb-4">Create New Password</h3>
                <form @submit.prevent="handleResetPassword">
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">New Password</label>
                        <input v-model="form.password" type="password" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button :disabled="loading" type="submit" class="w-full bg-[#3274B5] text-white font-bold py-2 rounded-lg hover:bg-[#285e94] transition flex justify-center items-center text-sm">
                        <span v-if="!loading">Update Password</span>
                        <div v-else class="loader"></div>
                    </button>
                </form>
            </div>

            <!-- Dashboard -->
            <div v-if="step === 'dashboard'">
                <!-- Admin Impersonation Banner -->
                <div v-if="isImpersonating" class="bg-purple-600 text-white text-center py-2 px-4 mb-4 rounded-lg max-w-[350px] mx-auto flex items-center justify-between">
                    <span class="text-sm font-medium">üëÅÔ∏è Viewing as: {{ profile?.name || profile?.email }}</span>
                    <button @click="signOut" class="text-xs bg-white/20 px-2 py-1 rounded hover:bg-white/30">Exit</button>
                </div>

                <div class="flex border-b mb-6 w-full max-w-[350px] mx-auto">
                    <button @click="tab = 'profile'" class="flex-1 px-1 md:px-4 py-2 font-medium text-gray-600 text-sm md:text-lg flex flex-col items-center transition-all">
                        <div class="flex flex-col items-center">
                            <svg class="w-5 h-5" :class="tab === 'profile' ? 'text-[#3274B5]' : 'text-black'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            <span class="whitespace-nowrap" :class="{'text-[#3274B5]': tab === 'profile'}">ÿ≠ÿ≥ÿßÿ®Ÿä</span>
                        </div>
                    </button>
                    <div class="w-px h-[0.7cm] bg-[#3274B5] self-center"></div>
                    <button @click="tab = 'instagram'" class="flex-1 px-1 md:px-4 py-2 font-medium text-gray-600 text-sm md:text-lg flex flex-col items-center transition-all">
                        <div class="flex flex-col items-center">
                            <svg class="w-5 h-5" :class="tab === 'instagram' ? 'text-[#3274B5]' : 'text-black'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            <span class="whitespace-nowrap" :class="{'text-[#3274B5]': tab === 'instagram'}">ÿßŸÜÿ≥ÿ™ÿ∫ÿ±ÿßŸÖ</span>
                        </div>
                    </button>
                    <div class="w-px h-[0.7cm] bg-[#3274B5] self-center"></div>
                    <button @click="tab = 'media'" class="flex-1 px-1 md:px-4 py-2 font-medium text-gray-600 text-sm md:text-lg flex flex-col items-center transition-all">
                        <div class="flex flex-col items-center">
                            <svg class="w-5 h-5" :class="tab === 'media' ? 'text-[#3274B5]' : 'text-black'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            <span class="whitespace-nowrap" :class="{'text-[#3274B5]': tab === 'media'}">ÿ±ŸÅÿπ ŸÖŸäÿØŸäÿß</span>
                        </div>
                    </button>
                    <div class="w-px h-[0.7cm] bg-[#3274B5] self-center"></div>
                    <button @click="tab = 'ai'" class="flex-1 px-1 md:px-4 py-2 font-medium text-gray-600 text-sm md:text-lg flex flex-col items-center transition-all">
                        <div class="flex flex-col items-center">
                            <svg class="w-5 h-5" :class="tab === 'ai' ? 'text-[#3274B5]' : 'text-black'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                            <span class="whitespace-nowrap" :class="{'text-[#3274B5]': tab === 'ai'}">ÿ∞ŸÉÿßÿ° ÿµŸÜÿπŸä</span>
                        </div>
                    </button>
                </div>

                <!-- Tab: Profile -->
                <div v-if="tab === 'profile'" class="w-full max-w-[350px] mx-auto">
                    <!-- Profile Header with Image -->
                    <div class="flex items-center gap-4 mb-[20px] px-4 bg-gray-50 rounded-lg border border-gray-100">
                        <img v-if="profile.profile_pic_url" :src="profile.profile_pic_url" class="w-16 h-16 rounded-full border-2 border-gray-200 object-cover">
                        <div v-else class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center text-gray-400 text-xl font-bold">?</div>
                        <div>
                            <h3 class="font-bold text-lg">{{ profile.name || profile.family_name || 'Family Profile' }}</h3>
                            <p class="text-xs text-gray-500">{{ profile.email }}</p>
                        </div>
                    </div>

                    <form @submit.prevent="updateProfile">
                        <div class="grid grid-cols-2 gap-4">
                                                        <div class="mb-4">
                                                            <label class="block text-sm font-bold mb-[6px] flex flex-row items-center justify-center gap-2 text-[#3274B5]">
                                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                                                                <span class="text-sm text-black">ŸÜŸàÿπ ÿßŸÑÿ≥ŸÉŸÜ</span>
                                                            </label>
                                                            <select v-model="profile.housing_type" class="mx-auto block border py-0 px-2 rounded text-sm h-[32px]" style="width: calc(66.666667% - 20px);">
                                                                <option style="font-size: 14px;" value="tent">‚õ∫ ÿÆŸäŸÖÿ©</option>
                                                                <option style="font-size: 14px;" value="school">üè´ ŸÖÿØÿ±ÿ≥ÿ©</option>
                                                                <option style="font-size: 14px;" value="damaged_home">üèöÔ∏è ÿ®Ÿäÿ™ ŸÖÿ™ÿ∂ÿ±ÿ±</option>
                                                                <option style="font-size: 14px;" value="open_air">üíÄ ÿ®ÿßŸÑÿπÿ±ÿßÿ°</option>
                                                            </select>
                                                        </div>
                                                        <div class="mb-4">
                                                            <label class="block text-sm font-bold mb-[6px] flex flex-row items-center justify-center gap-2 text-[#3274B5]">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 9l3 3m0 0l-3 3m3-3H8m13 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                                                <span class="text-sm text-black">ŸÖÿ±ÿßÿ™ ÿßŸÑŸÜÿ≤Ÿàÿ≠</span>
                                                            </label>
                                                            <input v-model="profile.displacement_count" type="number" class="mx-auto block border p-1 rounded text-sm h-[32px]" style="width: calc(66.666667% - 20px);">
                                                        </div>
                            
                                                    </div>
                            
                                                    <!-- Children Details Section -->
                                                    <div class="mb-6 border-t pt-4">
                                                        <label class="block text-sm font-bold mb-[10px] flex items-baseline gap-1">
                                                            <span class="text-base text-[#3274B5]">ÿ£ŸÅÿ±ÿßÿØ ÿßŸÑÿπÿßÿ¶ŸÑÿ©</span>
                                                            <span class="text-xs text-[#3274B5]">({{ profile.children_details?.length || 0 }})</span>
                                                            <span class="text-xs">Family Members</span>
                                                        </label>
                                                        
                                                        <!-- List of added children -->
                                                        <div v-if="profile.children_details && profile.children_details.length > 0" class="mb-4 space-y-2">
                                                            <div v-for="(member, index) in profile.children_details" :key="index" class="flex justify-between items-center bg-gray-50 p-2 rounded border text-sm" dir="ltr" style="text-align: left;">
                                                                <div class="flex flex-col">
                                                                    <span style="display: flex; gap: 0.25rem; align-items: center;">
                                                                        <span dir="auto">{{ member.nameDisplay || member.name }}</span>
                                                                        <span dir="ltr">|</span>
                                                                        <span dir="ltr">{{ (getRelationshipLabel(member.relationship, member.gender) || {en: 'Member', ar: ''}).en }}</span>
                                                                        <span dir="rtl">{{ (getRelationshipLabel(member.relationship, member.gender) || {en: 'Member', ar: ''}).ar }}</span>
                                                                        <span dir="ltr">|</span>
                                                                        <span dir="ltr">{{ member.gender === 'Male' ? '‚ôÇ' : '‚ôÄ' }}</span>
                                                                        <span dir="ltr">|</span>
                                                                        <span dir="ltr">{{ member.age }}</span>
                                                                    </span>
                                                                    <div class="text-sm text-gray-500" style="display: flex; gap: 0.25rem; align-items: center; flex-wrap: wrap;">
                                                                        <template v-if="member.status">
                                                                            <span dir="ltr" :class="{'text-green-600': member.status === 'Alive', 'text-red-600': member.status === 'Deceased', 'text-orange-500': member.status === 'Unknown'}">{{ getStatusLabel(member.status).en }}</span>
                                                                            <span dir="rtl" :class="{'text-green-600': member.status === 'Alive', 'text-red-600': member.status === 'Deceased', 'text-orange-500': member.status === 'Unknown'}">{{ getStatusLabel(member.status).ar }}</span>
                                                                            <span v-if="member.status === 'Deceased' && member.days_deceased" dir="ltr">| {{ member.days_deceased }} days</span>
                                                                            <span v-if="member.status === 'Unknown' && member.days_missing" dir="ltr">| {{ member.days_missing }} days</span>
                                                                        </template>
                                                                        <span v-if="member.condition" class="text-blue-600" dir="auto">| {{ member.conditionDisplay || member.condition }}</span>
                                                                        <span v-if="member.disability === 'yes'" dir="ltr">| ‚ôø</span>
                                                                    </div>
                                                                </div>
                                                                <button type="button" @click="removeChild(index)" class="text-gray-300 hover:text-gray-500 px-2 text-sm">√ó</button>
                                                            </div>
                                                        </div>
                            
                                                        <!-- Add new child form -->
                                                        <div class="bg-blue-50 p-3 rounded border border-blue-100">
                                                            <div class="mb-2 flex items-baseline gap-1 font-bold">
                                                                <span class="text-base text-[#3274B5]">ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ±ÿØ</span>
                                                                <span class="text-xs">| Add Member</span>
                                                            </div>
                                <div class="grid grid-cols-3 gap-2 mb-2">
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        </div>
                                        <input v-model="newMember.name" @input="newMember.name = newMember.name.replace(/[0-9]/g, '')" id="memberNameInput" type="text" placeholder="ÿßŸÑÿßÿ≥ŸÖ *" autocomplete="off" :class="['border py-0 pl-8 pr-2 rounded text-base placeholder:text-lg w-full h-[30px]', showValidationError && !newMember.name ? 'border-red-500 placeholder:text-red-500' : 'placeholder:text-black']">
                                    </div>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                        </div>
                                        <input v-model="newMember.age" type="number" placeholder="ÿßŸÑÿπŸÖÿ± *" :class="['border py-0 pl-8 pr-2 rounded text-base placeholder:text-lg w-full h-[30px]', showValidationError && !newMember.age ? 'border-red-500 placeholder:text-red-500' : 'placeholder:text-black']">
                                    </div>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                                        </div>
                                        <select v-model="newMember.gender" class="border py-0 pl-8 pr-1 rounded text-base w-full h-[30px]">
                                            <option value="Male">ÿ∞ŸÉÿ± ‚ôÇ</option>
                                            <option value="Female">ÿ£ŸÜÿ´Ÿâ ‚ôÄ</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                        </div>
                                        <select v-model="newMember.relationship" :class="['border py-0 pl-8 pr-1 rounded text-sm w-full h-[30px] appearance-none bg-white', showValidationError && !newMember.relationship ? 'border-red-500 text-red-500' : '']">
                                            <option value="" disabled selected>ÿµŸÑÿ© ÿßŸÑŸÇÿ±ÿßÿ®ÿ© *</option>
                                            <option value="Son/Daughter">ÿßÿ®ŸÜ/ÿßÿ®ŸÜÿ© | Son/Daughter</option>
                                            <option value="Husband/Wife">ÿ≤Ÿàÿ¨/ÿ≤Ÿàÿ¨ÿ© | Husband/Wife</option>
                                            <option value="Brother/Sister">ÿ£ÿÆ/ÿ£ÿÆÿ™ | Brother/Sister</option>
                                            <option value="Mother/Father">ÿ£ŸÖ/ÿ£ÿ® | Mother/Father</option>
                                            <option value="Nephew/Niece">ÿßÿ®ŸÜ ÿ£ÿÆ/ÿ®ŸÜÿ™ ÿ£ÿÆÿ™ | Nephew/Niece</option>
                                            <option value="Aunt/Uncle">ÿπŸÖÿ©ÿå ÿÆÿßŸÑÿ©/ÿπŸÖÿå ÿÆÿßŸÑ | Aunt/Uncle</option>
                                        </select>
                                    </div>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.0 0 00-6.364 0z"></path></svg>
                                        </div>
                                        <select v-model="newMember.status" :class="['border py-0 pl-8 pr-1 rounded text-sm w-full h-[30px] appearance-none bg-white', showValidationError && !newMember.status ? 'border-red-500 text-red-500' : '']">
                                            <option value="" disabled selected>ÿπŸÑŸâ ŸÇŸäÿØ ÿßŸÑÿ≠Ÿäÿßÿ©ÿü *</option>
                                            <option value="Alive">ÿ≠Ÿä Ÿäÿ±ÿ≤ŸÇ | Alive</option>
                                            <option value="Deceased">ŸÖÿ™ŸàŸÅŸä | Deceased</option>
                                            <option value="Unknown">ŸÖÿ¨ŸáŸàŸÑ | Unknown</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                                            <span class="text-xs">‚è≥</span>
                                        </div>
                                        <input
                                            v-model="newMember.status === 'Deceased' ? newMember.days_deceased : newMember.days_missing"
                                            type="number"
                                            :placeholder="newMember.status === 'Deceased' ? 'ÿ£ŸäÿßŸÖ ÿßŸÑŸàŸÅÿßÿ©' : (newMember.status === 'Unknown' ? 'ÿ£ŸäÿßŸÖ ÿßŸÑŸÅŸÇÿØÿßŸÜ' : 'ÿ£ŸäÿßŸÖ')"
                                            :disabled="!newMember.status || newMember.status === 'Alive'"
                                            class="border py-0 pl-8 pr-2 rounded text-sm w-full h-[30px] disabled:bg-gray-100 disabled:text-gray-400 disabled:cursor-not-allowed"
                                        >
                                    </div>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                                        </div>
                                        <input v-model="newMember.condition" type="text" placeholder="ÿ≠ÿßŸÑÿ© ÿµÿ≠Ÿäÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)" class="border py-0 pl-8 pr-2 rounded text-base placeholder:text-base placeholder:text-black w-full h-[30px]">
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-2 mb-0">
                                    <div class="flex items-center h-[30px]">
                                        <div class="flex border rounded overflow-hidden h-[30px] w-full">
                                            <span class="flex items-center px-2 text-xs text-gray-500 bg-gray-50 border-l whitespace-nowrap">ÿ•ÿπÿßŸÇÿ©ÿü</span>
                                            <button type="button" @click="newMember.disability = 'no'" :class="['flex-1 px-2 text-xs transition border-l', newMember.disability === 'no' ? 'bg-[#3274B5] text-white' : 'bg-white text-gray-600 hover:bg-gray-50']">ŸÑÿ£</button>
                                            <button type="button" @click="newMember.disability = 'yes'" :class="['flex-1 px-2 text-xs transition border-l', newMember.disability === 'yes' ? 'bg-[#3274B5] text-white' : 'bg-white text-gray-600 hover:bg-gray-50']">ÿ¢Ÿá</button>
                                        </div>
                                    </div>
                                    <div></div>
                                    <div class="flex items-center gap-2 justify-end">
                                        <button type="button" @click="addMember" class="px-3 py-1 bg-[#3274B5] text-white font-bold rounded-lg hover:bg-[#285e94] transition flex justify-center items-center text-xs gap-1 h-[30px] flex-shrink-0">
                                            <span>+ Add | </span>
                                            <span class="text-base">ÿ•ÿ∂ÿßŸÅÿ©</span>
                                        </button>
                                        <svg v-if="memberSaved" class="w-6 h-6 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Urgent Needs Section -->
                        <div class="mb-6 border-t pt-4">
                            <label class="block mb-1 flex items-baseline gap-1 font-bold">
                                <span class="text-base text-[#3274B5]">ÿßÿ≠ÿ™Ÿäÿßÿ¨ÿßÿ™ ÿπÿßÿ¨ŸÑÿ©</span>
                                <span class="text-xs">| Urgent Needs</span>
                            </label>
                            
                            <!-- List of added needs -->
                            <div v-if="profile.urgent_needs && profile.urgent_needs.length > 0" class="mb-4 space-y-2">
                                <div v-for="(need, index) in profile.urgent_needs" :key="index" class="flex justify-between items-center bg-gray-50 px-2 py-1 rounded border h-[30px]">
                                    <span class="text-sm">
                                        <span>{{ getUrgentNeedLabel(need).split('|')[0] }}</span>
                                        <span v-if="getUrgentNeedLabel(need).includes('|')" class="text-xs text-gray-600"> | {{ getUrgentNeedLabel(need).split('|')[1] }}</span>
                                    </span>
                                    <button type="button" @click="removeUrgentNeed(index)" class="text-gray-300 hover:text-gray-500 px-2 text-sm">√ó</button>
                                </div>
                            </div>

                            <div class="mb-4 flex gap-2">
                                <select v-model="newUrgentNeed" class="w-full border py-0 px-2 rounded text-base h-[30px]">
                                    <option value="" disabled>ÿßÿÆÿ™ÿ± ÿßÿ≠ÿ™Ÿäÿßÿ¨...</option>
                                    <option v-for="opt in urgentNeedOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
                                </select>
                                <div class="flex items-center gap-2">
                                    <button type="button" @click="addUrgentNeed" :disabled="!newUrgentNeed" class="px-4 bg-[#3274B5] text-white font-bold rounded-lg hover:bg-[#285e94] transition flex justify-center items-center text-xs disabled:cursor-not-allowed gap-1 h-[30px] whitespace-nowrap flex-shrink-0">
                                        <span>Add</span>
                                        <span class="text-[10px] text-white/70">|</span>
                                        <span class="text-base">ÿ•ÿ∂ÿßŸÅÿ©</span>
                                    </button>
                                    <svg v-if="urgentNeedSaved" class="w-6 h-6 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="block text-xs text-black mb-1 flex items-baseline gap-1 font-bold">
                                    <span class="text-base text-[#3274B5]">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®</span>
                                    <span>| Cash Amount Needed</span>
                                </label>
                                <input v-model="profile.urgent_need_amount" type="text" class="w-[60%] border p-2 rounded text-sm h-[30px]" style="width: calc(60% + 4px);" placeholder="e.g. $500">
                            </div>
                        </div>

                        <!-- PalPay Wallet Section -->
                        <div class="mb-6 border-t pt-4">
                            <div class="mb-4">
                                <label class="block text-xs text-black mb-1 flex items-baseline gap-1 font-bold">
                                    <span class="text-base text-[#3274B5]">ÿ±ŸÇŸÖ ŸÖÿ≠ŸÅÿ∏ÿ© ÿ®ÿßŸÑÿ®ÿßŸä ÿ∫ÿ≤ÿ©</span>
                                    <span class="text-[10px]">| Gaza PalPay Wallet phone number</span>
                                </label>
                                <input v-model="profile.palpay_phone" type="tel" class="w-full border p-2 rounded text-sm h-[30px]" placeholder="e.g. 0599123456">
                            </div>
                            <div class="mb-4">
                                <label class="block text-xs text-black mb-1 flex items-baseline gap-1 font-bold">
                                    <span class="text-base text-[#3274B5]">ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ¨ŸÑ ÿ®ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ©</span>
                                    <span class="text-[10px]">| Full name as registered on Wallet</span>
                                </label>
                                <input v-model="profile.palpay_name" type="text" class="w-full border p-2 rounded text-sm h-[30px]" placeholder="ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ">
                            </div>
                        </div>

                        <button type="submit" class="px-3 py-1 bg-[#3274B5] text-white font-bold rounded-lg hover:bg-[#285e94] transition flex justify-center items-center text-xs gap-1 h-[30px] mx-auto">
                            <span class="text-base">ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅ</span>
                            <span class="opacity-80">|</span>
                            <span>Save</span>
                        </button>
                    </form>
                </div>

                <!-- Tab: Media -->
                <div v-if="tab === 'media'">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg px-8 py-4 text-center mb-6">
                        <input type="file" multiple @change="handleFileUpload" class="hidden" id="fileInput" accept="image/*,video/*">
                        <label for="fileInput" class="cursor-pointer block group hover:text-[#3274B5] transition-colors">
                            <div class="text-black group-hover:text-[#3274B5] leading-tight text-center">
                                <div class="text-base font-bold mb-3">ÿµŸàÿ± ŸàŸÅŸäÿØŸäŸàŸáÿßÿ™ ŸÑÿ•ŸÜÿ¥ÿßÿ° ŸÅŸäÿØŸäŸà ÿ±ŸäŸÑÿ≤ ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä. ÿßÿ∂ÿ∫ÿ∑ ŸáŸÜÿß ŸÑŸÑÿ±ŸÅÿπ</div>
                                <div class="text-sm">Photos and Videos For AI Reel Generation. Click to Upload</div>
                            </div>
                        </label>
                    </div>
                    <div v-if="uploadStatus" class="mb-4 text-sm text-center" :class="uploadStatus.type === 'success' ? 'text-green-600' : 'text-red-600'">
                        {{ uploadStatus.message }}
                    </div>

                    <!-- Media Gallery -->
                    <div v-if="mediaFiles.length > 0" class="grid grid-cols-3 gap-2">
                        <div v-for="file in mediaFiles" :key="file.id" class="relative group aspect-square bg-gray-100 rounded overflow-hidden border border-gray-200">
                            <!-- Clickable Area for Preview -->
                            <div @click="previewFile = file" class="w-full h-full cursor-pointer">
                                <img v-if="file.metadata.mimetype.startsWith('image')" :src="file.url" class="w-full h-full object-cover">
                                <div v-else class="w-full h-full relative">
                                    <video :src="file.url + '#t=0.5'" class="w-full h-full object-cover bg-gray-900 pointer-events-none" preload="metadata" muted playsinline></video>
                                    <div class="absolute top-1 right-1 bg-black/60 rounded-full p-1 pointer-events-none">
                                        <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"/></svg>
                                    </div>
                                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                        <div class="bg-black/30 rounded-full p-2">
                                            <svg class="w-8 h-8 text-white opacity-80" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/></svg>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Delete Button (Bottom Right) - visible on hover -->
                            <button @click.stop="deleteMedia(file)" class="absolute bottom-1 right-1 bg-red-600 text-white p-1.5 rounded-full hover:bg-red-700 shadow-sm opacity-0 group-hover:opacity-100 transition z-10">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>

                            <!-- Edit/Info Button (Bottom Left) - visible on hover -->
                            <button @click.stop="openEditMedia(file)" title="Edit Text Description | ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸàÿµŸÅ" class="absolute bottom-1 left-1 bg-green-600 text-white p-1.5 rounded-full hover:bg-green-700 shadow-sm opacity-0 group-hover:opacity-100 transition z-10">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div v-else-if="!loading" class="text-center text-gray-400 text-sm mt-4">
                        No media uploaded yet.
                    </div>
                    <div v-if="loading" class="flex justify-center mt-4"><div class="loader"></div></div>
                </div>

                <!-- Tab: Instagram (Apify Scraper Flow) -->
                <div v-if="tab === 'instagram'">
                    <!-- Scraped Profile Display -->
                    <div v-if="scrapedProfile" class="bg-[#3274B5]/10 border border-[#3274B5]/30 p-3 rounded-lg mb-3 relative">
                        <!-- Unlink X Button -->
                        <button @click="unlinkInstagram" class="absolute top-2 right-2 text-[#3274B5] hover:text-red-500 transition p-1 rounded-full hover:bg-red-50" title="Unlink Instagram | ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ±ÿ®ÿ∑">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                        <div class="flex items-start gap-3">
                            <img v-if="scrapedProfile.profile_pic_url" :src="scrapedProfile.profile_pic_url" class="w-16 h-16 rounded-full border-2 border-[#3274B5] object-cover">
                            <div v-else class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center text-gray-400 text-xl font-bold">?</div>
                            <div class="flex-1">
                                <div class="flex items-center gap-2 text-[#3274B5] font-bold mb-1">
                                    <div class="w-2 h-2 bg-[#3274B5] rounded-full animate-pulse"></div>
                                    <span class="text-base">ÿ™ŸÖ ÿßŸÑÿ¨ŸÑÿ®</span>
                                </div>
                                <p class="text-xs text-gray-600">@{{ scrapedProfile.instagram_username }}</p>
                                <p v-if="scrapedProfile.full_name" class="text-xs text-gray-600">{{ scrapedProfile.full_name }}</p>
                                <div class="flex gap-3 text-xs text-gray-500 mt-1">
                                    <span class="flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                        <span>{{ scrapedProfile.followers_count?.toLocaleString() || 0 }} ŸÖÿ™ÿßÿ®ÿπ</span>
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                        <span>{{ scrapedProfile.posts_count || 0 }} ŸÖŸÜÿ¥Ÿàÿ±</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-[10px]">ÿ¢ÿÆÿ± ŸÅÿ≠ÿµ {{ formatScrapeDate(scrapedProfile.last_scraped_at) }}</p>
                    </div>

                    <!-- Connected via cookies (legacy) -->
                    <div v-else-if="profile.cookies" class="bg-blue-50 border border-blue-100 p-2 rounded-lg mb-2 flex justify-center">
                        <div class="flex flex-col items-start">
                            <div class="flex items-center gap-2 text-blue-700 font-bold mb-2">
                                <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                                <span class="text-sm tracking-wide">CONNECTED</span>
                                <span class="text-lg">ŸÖÿ™ÿµŸÑ</span>
                            </div>
                            <p class="text-base font-mono text-gray-800 mb-2">@{{ profile.instagram_handle || profile.handle }}</p>
                            <p class="text-xs text-gray-500">(Admin-managed session)</p>
                        </div>
                    </div>

                    <!-- Not connected -->
                    <div v-else class="bg-yellow-50 p-2 rounded mb-2 text-center">
                        <p class="text-yellow-700 flex justify-center items-baseline gap-1 font-bold">
                            <span class="text-base">ÿßŸÜÿ≥ÿ™ÿ∫ÿ±ÿßŸÖ ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ</span>
                            <span class="text-xs">| Not Connected</span>
                        </p>
                    </div>

                    <!-- Scrape Form -->
                    <div class="mt-4 border-t pt-4">
                        <form @submit.prevent="handleInstaScrape">
                            <div class="mb-4">
                                <label class="block mb-1 flex flex-col items-start gap-[5px] text-[#3274B5]">
                                    <span class="text-base font-bold leading-none">ÿßÿ≥ŸÖ ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿßŸÜÿ≥ÿ™ÿ∫ÿ±ÿßŸÖ</span>
                                    <span class="text-xs font-normal leading-none">IG username</span>
                                </label>
                                <input v-model="form.insta_username" type="text" class="w-full border p-2 rounded text-sm" placeholder="e.g. @ahmed_gaza">
                            </div>
                            <div class="mb-4">
                                <label class="block mb-1 flex flex-col items-start gap-[5px] text-[#3274B5]">
                                    <span class="text-base font-bold leading-none">ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</span>
                                    <span class="text-xs font-normal leading-none">Password (Optional)</span>
                                </label>
                                <input v-model="form.insta_password" type="password" :disabled="!profile.instagram_password_enabled" class="w-full border border-[#3274B5]/30 bg-[#3274B5]/10 p-2 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                <p v-if="!profile.instagram_password_enabled" class="text-xs text-gray-500 mt-1 text-right">ÿ™ŸàÿßÿµŸÑ ŸÖÿπ ÿßŸÑÿ•ÿØÿßÿ±ÿ© ŸÑÿ™ŸÅÿπŸäŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±</p>
                                <p v-else class="text-xs text-gray-400 mt-1">Password saved for admin-managed account recovery only</p>
                            </div>
                            <button :disabled="loading" type="submit" class="w-auto px-3 mx-auto block bg-[#3274B5] text-white font-bold py-1.5 rounded-lg hover:bg-[#285e94] transition flex justify-center items-center text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                                <span v-if="!loading">{{ scrapedProfile ? 'Rescrape Profile | ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ¨ŸÑÿ®' : 'Scrape Profile | ÿ¨ŸÑÿ® ÿßŸÑŸÖŸÑŸÅ' }}</span>
                                <div v-else class="loader"></div>
                            </button>
                        </form>
                        <p v-if="scrapeMessage" class="text-center text-base mt-3" :class="scrapeMessage.type === 'success' ? 'text-green-600' : scrapeMessage.type === 'error' ? 'text-red-600' : 'text-blue-600'">
                            {{ scrapeMessage.text }}
                        </p>

                        <!-- Backup Followers Button -->
                        <div v-if="scrapedProfile" class="mt-4 pt-4 border-t border-gray-200" style="padding-bottom: 3px;">
                            <div class="flex items-center justify-between mb-1">
                                <div>
                                    <h4 class="text-sm font-bold text-[#3274B5]">ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÑŸÑŸÖÿ™ÿßÿ®ÿπŸäŸÜ</h4>
                                    <p class="text-xs text-gray-500 mb-1">Backup Engaged Followers</p>
                                </div>
                                <span v-if="engagedFollowersCount" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">
                                    {{ engagedFollowersCount }} backed up
                                </span>
                            </div>
                            <button @click="backupFollowers" disabled class="w-auto px-3 mx-auto block bg-gray-400 text-white font-bold py-1.5 rounded-lg transition flex justify-center items-center text-sm opacity-50 cursor-not-allowed mt-3">
                                <span v-if="!backupLoading">Backup Followers | ŸÜÿ≥ÿÆ ÿßŸÑŸÖÿ™ÿßÿ®ÿπŸäŸÜ</span>
                                <div v-else class="loader"></div>
                            </button>
                            <p v-if="backupMessage" class="text-center text-xs mt-2" :class="backupMessage.type === 'success' ? 'text-green-600' : 'text-red-600'">
                                {{ backupMessage.text }}
                            </p>
                        </div>
                    </div>

                    <!-- Scraped Content Preview -->
                    <div v-if="scrapedContent && scrapedContent.length > 0" class="mt-4 mb-4 border-t pt-4" style="padding-bottom: 10px;">
                        <h4 class="text-sm font-bold flex items-baseline gap-1" style="margin-bottom: 10px;">
                            <span class="text-base text-[#3274B5]">ŸÖÿ≠ÿ™ŸàŸâ ŸÖÿ≥ÿ™Ÿàÿ±ÿØ</span>
                            <span class="text-xs font-normal text-gray-500">| Imported Content ({{ scrapedContent.length }})</span>
                        </h4>
                        <div style="height: 6px;"></div>
                        <div class="grid grid-cols-3 gap-1">
                            <div v-for="item in scrapedContent.slice(0, 9)" :key="item.id" class="relative group aspect-square bg-gray-100 rounded overflow-hidden border border-gray-200">
                                <!-- Clickable Area for Preview -->
                                <div @click="openScrapedPreview(item)" class="w-full h-full cursor-pointer">
                                    <template v-if="item.is_video">
                                        <img v-if="item.display_url" :src="item.display_url" class="w-full h-full object-cover">
                                        <div class="absolute top-1 right-1 bg-black/60 rounded-full p-1 pointer-events-none">
                                            <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"/></svg>
                                        </div>
                                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                            <div class="bg-black/30 rounded-full p-2">
                                                <svg class="w-8 h-8 text-white opacity-80" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/></svg>
                                            </div>
                                        </div>
                                    </template>
                                    <template v-else>
                                        <img v-if="item.display_url" :src="item.display_url" class="w-full h-full object-cover">
                                        <div v-else class="w-full h-full flex items-center justify-center text-gray-400 text-xs">No image</div>
                                    </template>
                                </div>

                                <!-- Edit Button (Bottom Left) - visible on hover -->
                                <button @click.stop="openEditScraped(item)" title="Edit Text Description | ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸàÿµŸÅ" class="absolute bottom-1 left-1 bg-green-600 text-white p-1.5 rounded-full hover:bg-green-700 shadow-sm opacity-0 group-hover:opacity-100 transition z-10">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: AI Generated Content -->
                <div v-if="tab === 'ai'" class="w-full max-w-[350px] mx-auto">
                    <div class="text-center py-8">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-br from-purple-100 to-blue-100 flex items-center justify-center">
                            <svg class="w-8 h-8 text-[#3274B5]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2">ŸÖÿ≠ÿ™ŸàŸâ ÿ∞ŸÉÿßÿ° ÿµŸÜÿπŸä</h3>
                        <p class="text-sm text-gray-500 mb-1">AI Generated Content</p>
                        <p class="text-xs text-gray-400 mt-4">ŸÇÿ±Ÿäÿ®ÿßŸã | Coming Soon</p>
                    </div>
                </div>
            </div>

            <!-- Lightbox Modal -->
            <div v-if="previewFile" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4" @click="previewFile = null">
                <div class="relative max-w-4xl w-full max-h-screen flex flex-col items-center" @click.stop>
                    <button @click="previewFile = null" class="absolute -top-10 right-0 text-white hover:text-gray-300">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                    
                    <img v-if="previewFile.metadata.mimetype.startsWith('image')" :src="previewFile.url" class="max-w-full max-h-[80vh] rounded shadow-2xl">
                    <video v-else :src="previewFile.url" class="max-w-full max-h-[80vh] rounded shadow-2xl" controls autoplay playsinline></video>
                </div>
            </div>

            <!-- 2FA Form -->
            <div v-if="step === '2fa'">
                <p class="text-sm text-gray-600 mb-4 text-center">Instagram sent a code to your phone/email. Please enter it below.</p>
                <form @submit.prevent="handle2FA">
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Security Code</label>
                        <input v-model="form.code" type="text" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-xl tracking-widest" required placeholder="123456">
                    </div>
                    <button :disabled="loading" type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition flex justify-center items-center">
                        <span v-if="!loading">Verify Code</span>
                        <div v-else class="loader"></div>
                    </button>
                </form>
            </div>

            <!-- Media Editor Modal -->
            <div v-if="isMediaEditorOpen" class="fixed inset-0 bg-black/90 z-50 flex flex-col p-4 overflow-y-auto">
                <div class="w-full max-w-2xl mx-auto bg-white rounded-lg shadow-xl p-4 flex-1 flex flex-col">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="font-bold text-lg flex items-center gap-2">
                            <span class="text-[#3274B5]">Add Details</span>
                            <span>| ÿ•ÿ∂ÿßŸÅÿ© ÿ™ŸÅÿßÿµŸäŸÑ</span>
                        </h3>
                        <button @click="isMediaEditorOpen = false; mediaStaging = []" class="text-gray-500 hover:text-red-500">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto space-y-4">
                        <div v-for="(item, index) in mediaStaging" :key="index" class="flex gap-3 border rounded p-2 relative items-center">
                            <!-- Thumbnail -->
                            <div class="w-24 h-24 flex-shrink-0 bg-gray-100 rounded overflow-hidden relative border border-gray-200">
                                <img v-if="item.type.startsWith('image')" :src="item.url" class="w-full h-full object-cover">
                                <video v-else :src="item.url + '#t=0.5'" class="w-full h-full object-cover bg-gray-900" preload="metadata" playsinline muted></video>
                                <button @click="removeStagedMedia(index)" class="absolute top-0 right-0 bg-red-500 text-white rounded-bl p-1 hover:bg-red-600 z-10">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                            
                            <!-- Description Input -->
                            <div class="flex-1 flex flex-col h-24">
                                <label class="block mb-[2px] leading-tight text-[#3274B5]">
                                    <div class="flex flex-row items-center gap-1 flex-wrap">
                                        <span class="text-sm font-bold whitespace-nowrap">ÿßŸÉÿ™ÿ® ŸàÿµŸÅ</span>
                                    </div>
                                </label>
                                <textarea v-model="item.description" class="w-full border rounded p-2 text-sm flex-1 resize-none focus:ring-2 focus:ring-[#3274B5] focus:outline-none" placeholder="ÿßÿ¥ÿ±ÿ≠ ŸÖÿß Ÿäÿ≠ÿØÿ´... | Explain..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t flex justify-center">
                        <button @click="sendMedia" :disabled="isUploading" class="w-auto px-4 bg-[#3274B5] text-white font-bold py-1 rounded-full hover:bg-[#285e94] transition flex justify-center items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed h-[36px]">
                            <span v-if="!isUploading" class="text-lg">ÿ•ÿ±ÿ≥ÿßŸÑ</span>
                            <span v-if="!isUploading" class="text-white/50">|</span>
                            <span v-if="!isUploading">Send</span>
                            <div v-else class="loader border-white border-t-transparent"></div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Edit Description Modal -->
            <div v-if="editingFile" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-lg shadow-xl p-4 max-w-lg w-full" @click.stop>
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="font-bold text-lg flex items-center gap-2">
                            <span class="text-[#3274B5]">ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ</span>
                            <span>| Edit Details</span>
                        </h3>
                        <button @click="editingFile = null" class="text-gray-500 hover:text-red-500">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-xs font-bold mb-1 flex items-baseline gap-1 text-[#3274B5]">
                            <span class="text-sm">ÿßŸÉÿ™ÿ® ŸàÿµŸÅŸãÿß</span>
                        </label>
                        <textarea v-model="editingFile.description" class="w-full border rounded p-2 text-sm h-32 resize-none focus:ring-2 focus:ring-[#3274B5] focus:outline-none" placeholder="ÿßÿ¥ÿ±ÿ≠ ŸÖÿß Ÿäÿ≠ÿØÿ´ ŸÅŸä ÿßŸÑÿµŸàÿ±ÿ©/ÿßŸÑŸÅŸäÿØŸäŸà... | Explain what is happening..."></textarea>
                    </div>

                    <div class="flex justify-end gap-2">
                        <button @click="editingFile = null" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded text-xs">Cancel</button>
                        <button @click="saveMediaDescription" class="w-auto px-3 py-1 bg-[#3274B5] text-white font-bold rounded-lg hover:bg-[#285e94] transition flex justify-center items-center text-xs gap-1 h-[30px]">
                            <span>Save | </span>
                            <span class="text-base">ÿ≠ŸÅÿ∏</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Edit Scraped Content Description Modal -->
            <div v-if="editingScraped" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-lg shadow-xl p-4 max-w-lg w-full" @click.stop>
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="font-bold text-lg flex items-center gap-2">
                            <span class="text-[#3274B5]">ŸàÿµŸÅ ŸÑŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿµŸÜÿπŸä</span>
                            <span>| AI Description</span>
                        </h3>
                        <button @click="editingScraped = null" class="text-gray-500 hover:text-red-500">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>

                    <!-- Thumbnail preview -->
                    <div class="flex gap-3 mb-4">
                        <div class="w-20 h-20 flex-shrink-0 bg-gray-100 rounded overflow-hidden border">
                            <img v-if="editingScraped.display_url" :src="editingScraped.display_url" class="w-full h-full object-cover">
                        </div>
                        <div v-if="editingScraped.caption" class="flex-1 text-xs text-gray-500 overflow-hidden line-clamp-3">
                            {{ editingScraped.caption }}
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-xs font-bold mb-1 flex items-baseline gap-1 text-[#3274B5]">
                            <span class="text-sm">ÿßŸÉÿ™ÿ® ŸàÿµŸÅŸãÿß ÿ•ÿ∂ÿßŸÅŸäŸãÿß</span>
                            <span class="text-xs font-normal text-gray-500">| Add context for AI</span>
                        </label>
                        <textarea v-model="editingScraped.description" class="w-full border rounded p-2 text-sm h-32 resize-none focus:ring-2 focus:ring-[#3274B5] focus:outline-none" placeholder="ÿ£Ÿä ÿ™ŸÅÿßÿµŸäŸÑ ÿ•ÿ∂ÿßŸÅŸäÿ© ÿπŸÜ ÿßŸÑÿµŸàÿ±ÿ©/ÿßŸÑŸÅŸäÿØŸäŸà... | Any additional context..."></textarea>
                    </div>

                    <div class="flex justify-end gap-2">
                        <button @click="editingScraped = null" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded text-xs">Cancel</button>
                        <button @click="saveScrapedDescription" class="w-auto px-3 py-1 bg-[#3274B5] text-white font-bold rounded-lg hover:bg-[#285e94] transition flex justify-center items-center text-xs gap-1 h-[30px]">
                            <span>Save | </span>
                            <span class="text-base">ÿ≠ŸÅÿ∏</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div v-if="error" class="mt-4 p-3 bg-red-50 text-red-700 text-sm rounded border border-red-200">
                {{ error }}
            </div>

            <div class="mt-6 text-center">
                <p class="text-xs text-gray-400">
                    <span class="inline-block w-2 h-2 bg-green-500 rounded-full mr-1"></span>
                    End-to-End Encrypted
                </p>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() { 
                return { 
                    step: 'portal_login', // portal_login, dashboard, 2fa, success
                    authMode: 'register',
                    tab: sessionStorage.getItem('current_tab') || 'profile',
                    resetToken: null,
                    isImpersonating: false, // True when admin is viewing as this family
                    loading: false,
                    isUploading: false,
                    error: null, 
                    token: null,
                    previewFile: null,
                    showInstaLogin: false,
                    uploadStatus: null,
                    mediaFiles: [],
                    profile: {},
                    mediaStaging: [],
                    isMediaEditorOpen: false,
                    editingFile: null,
                    editingScraped: null,
                    newUrgentNeed: '',
                    newMember: { name: '', age: '', gender: 'Male', relationship: '', status: '', days_deceased: '', days_missing: '', condition: '', disability: '' },
                    scrapedProfile: null,
                    scrapedContent: [],
                    scrapeStatus: { canScrape: true, minutesRemaining: 0 },
                    scrapeMessage: null,
                    backupLoading: false,
                    backupMessage: null,
                    engagedFollowersCount: 0,
                    translationCache: {},
                    memberSaved: false,
                    urgentNeedSaved: false,
                    showValidationError: false,
                    urgentNeedOptions: [
                        { value: "floods", label: "üåä ŸÜŸàÿßÿ¨Ÿá ŸÅŸäÿ∂ÿßŸÜÿßÿ™ | Facing severe floods" },
                        { value: "displacement", label: "üö∂ ÿßÿ≥ÿ™ŸÑŸÖŸÜÿß ÿ£ŸÖÿ± ÿ•ÿÆŸÑÿßÿ° | Displacement order" },
                        { value: "new_tent", label: "üõñ ÿßŸÑÿÆŸäŸÖÿ© ÿ™ÿØŸÖÿ±ÿ™ (ÿ®ÿØŸÜÿß ÿ¨ÿØŸäÿØÿ©) | Bad tent" },
                        { value: "home_repair", label: "üß± ÿßŸÑÿ®Ÿäÿ™ ÿ®ÿØŸà ÿ™ÿ±ŸÖŸäŸÖ | Repairs" },
                        { value: "tent_repair", label: "üõ†Ô∏è ÿßŸÑÿÆŸäŸÖÿ© ÿ®ÿØŸáÿß ÿ™ÿµŸÑŸäÿ≠ | Broken tent needs repair" },
                        { value: "tent_tarp", label: "‚õ∫ ÿßŸÑÿÆŸäŸÖÿ© ÿ®ÿØŸáÿß ÿ¥ÿßÿØÿ± | Tarp" },
                        { value: "food", label: "üç≤ ÿ®ÿ≠ÿßÿ¨ÿ© ŸÖÿßÿ≥ÿ© ŸÑÿ£ŸÉŸÑ | Food" },
                        { value: "medicines", label: "üíä ÿ®ÿØŸÜÿß ÿØŸàÿßÿ° ÿ∂ÿ±Ÿàÿ±Ÿä | Medicines urgently needed" },
                        { value: "blankets", label: "üß£ ÿ®ÿØŸÜÿß ÿ®ÿ∑ÿßŸÜŸäÿßÿ™ | Blankets needed" },
                        { value: "clothes", label: "üß• ÿ®ÿØŸÜÿß ŸàÿßÿπŸä ÿ¥ÿ™ŸàŸä | Clothes" },
                        { value: "medical_op", label: "üè• ÿ™ŸÉÿßŸÑŸäŸÅ ÿπŸÖŸÑŸäÿ© | Operation" },
                        { value: "medical_consult", label: "ü©∫ ÿßÿ≥ÿ™ÿ¥ÿßÿ±ÿ© ÿ∑ÿ®Ÿäÿ© ÿπÿßÿ¨ŸÑÿ© | Consultation" },
                        { value: "rent", label: "üíµ ÿπŸÑŸäŸÜÿß ÿ•Ÿäÿ¨ÿßÿ± ŸÖÿ™ÿ£ÿÆÿ± | Rent arrears overdue" },
                        { value: "evacuation", label: "üöå ÿ™ŸÉÿßŸÑŸäŸÅ ÿßŸÑÿ≥ŸÅÿ± ŸÑŸÖÿµÿ± | Egypt" },
                        { value: "business_setup", label: "üíº ÿ™ŸÉÿßŸÑŸäŸÅ ÿ™ÿ£ÿ≥Ÿäÿ≥ ŸÖÿ¥ÿ±Ÿàÿπ | Business" },
                        { value: "campaign", label: "üíª ÿØÿπŸÖ ÿßŸÑÿ≠ŸÖŸÑÿ© | Financing" },
                        { value: "other", label: "‚ùì ÿßÿ≠ÿ™Ÿäÿßÿ¨ÿßÿ™ ÿ™ÿßŸÜŸäÿ© | Necessities" }
                    ],
                    form: { email: '', family_name: '', password: '', insta_username: '', insta_password: '', code: '' } 
                } 
            },
            watch: {
                tab(newTab) {
                    sessionStorage.setItem('current_tab', newTab);
                    if (newTab === 'media') this.fetchMedia();
                    if (newTab === 'instagram') this.fetchScrapedProfile();
                }
            },
            mounted() {
                // Check for admin impersonation token in URL first
                const urlParams = new URLSearchParams(window.location.search);
                const impersonateToken = urlParams.get('impersonate');
                if (impersonateToken) {
                    // Admin is viewing as this family - use impersonation token
                    this.token = impersonateToken;
                    this.isImpersonating = true;
                    sessionStorage.setItem('portal_token', impersonateToken);
                    this.step = 'dashboard';
                    this.fetchProfile();
                    this.fetchScrapedProfile();
                    // Clean URL (remove impersonate param)
                    window.history.replaceState({}, document.title, "/");
                    return;
                }

                // Check for local token (SessionStorage for tab persistence only)
                const localToken = sessionStorage.getItem('portal_token');
                if (localToken) {
                    this.token = localToken;
                    this.step = 'dashboard';

                    // Restore active tab
                    const savedTab = sessionStorage.getItem('current_tab');
                    if (savedTab) this.tab = savedTab;

                    this.fetchProfile();
                    this.fetchScrapedProfile(); // Always load scraped Instagram data

                    // If restoring directly to media tab, fetch media immediately
                    if (this.tab === 'media') this.fetchMedia();
                }

                // Check for reset token in URL
                const resetToken = urlParams.get('token');
                if (resetToken) {
                    this.resetToken = resetToken;
                    this.step = 'reset_password';
                    // Clean URL
                    window.history.replaceState({}, document.title, "/");
                }
            },
            methods: {
                getRunningTime() {
                    if (!this.profile.created_at) return '0';
                    const start = new Date(this.profile.created_at);
                    const now = new Date();
                    const diff = now - start;
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    return `${days}`;
                },
                signOut() {
                    this.token = null;
                    this.profile = {};
                    this.step = 'portal_login';
                    this.authMode = 'login';
                    sessionStorage.removeItem('portal_token');
                    sessionStorage.removeItem('current_tab');
                },
                async handlePortalLogin() {
                    this.loading = true; this.error = null;
                    try {
                        const res = await fetch('/api/portal/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: this.form.email, password: this.form.password })
                        });
                        const data = await res.json();
                        if (data.error) throw new Error(data.error);
                        
                        this.token = data.token;
                        sessionStorage.setItem('portal_token', data.token);
                        this.profile = data.user;
                        this.form.insta_username = data.user.handle || ''; // Pre-fill if exists
                        this.step = 'dashboard';
                        this.fetchProfile(); // Get full details
                        this.fetchScrapedProfile(); // Load scraped Instagram data
                    } catch (e) { this.error = e.message; } finally { this.loading = false; }
                },
                async handlePortalRegister() {
                    this.loading = true; this.error = null;
                    try {
                        const res = await fetch('/api/portal/register', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: this.form.email, password: this.form.password, family_name: this.form.family_name })
                        });
                        const data = await res.json();
                        if (data.error) throw new Error(data.error);
                        
                        this.token = data.token;
                        sessionStorage.setItem('portal_token', data.token);
                        this.profile = data.user;
                        this.step = 'dashboard';
                        this.fetchProfile(); // Get full details
                    } catch (e) { this.error = e.message; } finally { this.loading = false; }
                },
                async handleForgotPassword() {
                    this.loading = true; this.error = null;
                    try {
                        await fetch('/api/portal/forgot-password', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: this.form.email })
                        });
                        alert('If an account exists, a reset link has been sent to your email (Check Server Console for link).');
                        this.step = 'portal_login';
                    } catch (e) { this.error = 'Request failed'; } finally { this.loading = false; }
                },
                async handleResetPassword() {
                    this.loading = true; this.error = null;
                    try {
                        const res = await fetch('/api/portal/reset-password', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ token: this.resetToken, newPassword: this.form.password })
                        });
                        if (res.ok) { alert('Password updated! Please login.'); this.step = 'portal_login'; }
                        else throw new Error('Invalid or expired token');
                    } catch (e) { this.error = e.message; } finally { this.loading = false; }
                },
                async fetchProfile() {
                    try {
                        const res = await fetch('/api/portal/me', { headers: { 'x-portal-token': this.token } });
                        if (res.status === 401) {
                            // Token invalid (server restarted or session expired)
                            this.signOut();
                            return;
                        }
                        this.profile = await res.json();
                        // Ensure children_details array exists
                        if (!this.profile.children_details) this.profile.children_details = [];
                        // Ensure urgent_needs array exists
                        if (!this.profile.urgent_needs) this.profile.urgent_needs = [];
                        // Pre-fill Instagram username if available
                        if (this.profile.instagram_handle && !this.form.insta_username) {
                            this.form.insta_username = this.profile.instagram_handle;
                        }

                        // Translate existing family members
                        for (const member of this.profile.children_details) {
                            if (member.name && !member.nameDisplay) {
                                member.nameDisplay = await this.getBilingualText(member.name);
                            }
                            if (member.condition && !member.conditionDisplay) {
                                member.conditionDisplay = await this.getBilingualText(member.condition);
                            }
                        }
                    } catch (e) {
                        console.error('Fetch profile error', e);
                    }
                },
                async updateProfile() {
                    // Sync count
                    this.profile.children_count = this.profile.children_details.length;
                    await fetch('/api/portal/profile', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'x-portal-token': this.token },
                        body: JSON.stringify(this.profile)
                    });
                },
                async addMember() {
                    // Validate required fields
                    if (!this.newMember.name || !this.newMember.age || !this.newMember.relationship || !this.newMember.status) {
                        // Show validation errors for 4 seconds
                        this.showValidationError = true;
                        setTimeout(() => {
                            this.showValidationError = false;
                        }, 4000);
                        return;
                    }

                    if (!this.profile.children_details) this.profile.children_details = [];

                    // Add translations for name and condition
                    const memberWithTranslations = { ...this.newMember };
                    if (memberWithTranslations.name) {
                        memberWithTranslations.nameDisplay = await this.getBilingualText(memberWithTranslations.name);
                    }
                    if (memberWithTranslations.condition) {
                        memberWithTranslations.conditionDisplay = await this.getBilingualText(memberWithTranslations.condition);
                    }

                    this.profile.children_details.push(memberWithTranslations);
                    this.newMember = { name: '', age: '', gender: 'Male', relationship: '', status: '', days_deceased: '', days_missing: '', condition: '', disability: '' }; // Reset

                    // Show green checkmark immediately
                    this.memberSaved = true;
                    setTimeout(() => {
                        this.memberSaved = false;
                    }, 5000);

                    // Update profile in background
                    await this.updateProfile();
                },
                async removeChild(index) {
                    this.profile.children_details.splice(index, 1);
                    await this.updateProfile();
                },
                async addUrgentNeed() {
                    if (!this.profile.urgent_needs) this.profile.urgent_needs = [];
                    if (!this.profile.urgent_needs.includes(this.newUrgentNeed)) {
                        this.profile.urgent_needs.push(this.newUrgentNeed);
                    }
                    this.newUrgentNeed = '';

                    // Show green checkmark immediately
                    this.urgentNeedSaved = true;
                    setTimeout(() => {
                        this.urgentNeedSaved = false;
                    }, 5000);

                    // Update profile in background
                    await this.updateProfile();
                },
                async removeUrgentNeed(index) {
                    this.profile.urgent_needs.splice(index, 1);
                    await this.updateProfile();
                },
                getUrgentNeedLabel(value) {
                    const option = this.urgentNeedOptions.find(o => o.value === value);
                    return option ? option.label : value;
                },
                getRelationshipLabel(relationship, gender) {
                    const isMale = gender === 'Male';
                    const map = {
                        'Son/Daughter': isMale ? { en: 'Son', ar: 'ÿßÿ®ŸÜ' } : { en: 'Daughter', ar: 'ÿßÿ®ŸÜÿ©' },
                        'Husband/Wife': isMale ? { en: 'Husband', ar: 'ÿ≤Ÿàÿ¨' } : { en: 'Wife', ar: 'ÿ≤Ÿàÿ¨ÿ©' },
                        'Brother/Sister': isMale ? { en: 'Brother', ar: 'ÿ£ÿÆ' } : { en: 'Sister', ar: 'ÿ£ÿÆÿ™' },
                        'Mother/Father': isMale ? { en: 'Father', ar: 'ÿ£ÿ®' } : { en: 'Mother', ar: 'ÿ£ŸÖ' },
                        'Nephew/Niece': isMale ? { en: 'Nephew', ar: 'ÿßÿ®ŸÜ ÿ£ÿÆ' } : { en: 'Niece', ar: 'ÿ®ŸÜÿ™ ÿ£ÿÆÿ™' },
                        'Aunt/Uncle': isMale ? { en: 'Uncle', ar: 'ÿπŸÖÿå ÿÆÿßŸÑ' } : { en: 'Aunt', ar: 'ÿπŸÖÿ©ÿå ÿÆÿßŸÑÿ©' }
                    };
                    return map[relationship] || { en: relationship, ar: '' };
                },
                getStatusLabel(status) {
                    const map = {
                        'Alive': { en: 'Alive', ar: 'ÿ≠Ÿä Ÿäÿ±ÿ≤ŸÇ' },
                        'Deceased': { en: 'Deceased', ar: 'ŸÖÿ™ŸàŸÅŸä' },
                        'Unknown': { en: 'Unknown', ar: 'ŸÖÿ¨ŸáŸàŸÑ' }
                    };
                    return map[status] || { en: status, ar: '' };
                },
                async translateText(text, targetLang = 'en') {
                    if (!text || !text.trim()) return text;

                    // Check cache first
                    const cacheKey = `${text}_${targetLang}`;
                    if (this.translationCache[cacheKey]) {
                        return this.translationCache[cacheKey];
                    }

                    try {
                        const res = await fetch('/api/translate', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-portal-token': this.token
                            },
                            body: JSON.stringify({ text, targetLang })
                        });

                        if (!res.ok) throw new Error('Translation failed');

                        const data = await res.json();
                        // Cache the result
                        this.translationCache[cacheKey] = data.translation;
                        return data.translation;
                    } catch (error) {
                        console.error('Translation error:', error);
                        return text; // Return original text on error
                    }
                },
                async getBilingualText(text) {
                    if (!text || !text.trim()) return text;

                    // Detect if text is primarily Arabic (contains Arabic characters)
                    const isArabic = /[\u0600-\u06FF]/.test(text);

                    if (isArabic) {
                        // Arabic ‚Üí English
                        const translation = await this.translateText(text, 'en');
                        return `${translation} ${text}`;
                    } else {
                        // English ‚Üí Arabic
                        const translation = await this.translateText(text, 'ar');
                        return `${text} ${translation}`;
                    }
                },
                async handleFileUpload(e) {
                    const files = Array.from(e.target.files);
                    if (!files.length) return;
                    
                    for (const file of files) {
                        this.mediaStaging.push({
                            file,
                            url: URL.createObjectURL(file),
                            type: file.type,
                            description: ''
                        });
                    }
                    this.isMediaEditorOpen = true;
                    e.target.value = ''; // Reset input
                },
                removeStagedMedia(index) {
                    this.mediaStaging.splice(index, 1);
                    if (this.mediaStaging.length === 0) this.isMediaEditorOpen = false;
                },
                openEditMedia(file) {
                    this.editingFile = { ...file, description: file.metadata?.description || '' };
                },
                async saveMediaDescription() {
                    if (!this.editingFile || !this.editingFile.id) {
                        alert('Error: Missing file ID');
                        return;
                    }

                    try {
                        const res = await fetch('/api/portal/media/update', {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'x-portal-token': this.token 
                            },
                            body: JSON.stringify({ 
                                id: this.editingFile.id,
                                description: this.editingFile.description 
                            })
                        });

                        if (!res.ok) {
                            const errData = await res.json().catch(() => ({}));
                            throw new Error(errData.error || 'Update failed');
                        }

                        // Update local state
                        const index = this.mediaFiles.findIndex(f => f.id === this.editingFile.id);
                        if (index !== -1) {
                            if (!this.mediaFiles[index].metadata) this.mediaFiles[index].metadata = {};
                            this.mediaFiles[index].metadata.description = this.editingFile.description;
                        }
                        alert('Description saved!');
                        this.editingFile = null;

                    } catch (e) {
                        console.error('Save description error:', e);
                        alert('Failed to save description: ' + e.message);
                    }
                },
                openScrapedPreview(item) {
                    // Normalize scraped item to work with existing lightbox
                    this.previewFile = {
                        url: item.is_video && item.video_url ? item.video_url : item.display_url,
                        metadata: {
                            mimetype: item.is_video ? 'video/mp4' : 'image/jpeg'
                        }
                    };
                },
                openEditScraped(item) {
                    this.editingScraped = {
                        id: item.id,
                        short_code: item.short_code,
                        caption: item.caption || '',
                        description: item.description || '',
                        display_url: item.display_url,
                        is_video: item.is_video
                    };
                },
                async saveScrapedDescription() {
                    if (!this.editingScraped || !this.editingScraped.id) {
                        alert('Error: Missing content ID');
                        return;
                    }

                    try {
                        const res = await fetch('/api/portal/instagram/content/update', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-portal-token': this.token
                            },
                            body: JSON.stringify({
                                id: this.editingScraped.id,
                                description: this.editingScraped.description
                            })
                        });

                        if (!res.ok) {
                            const errData = await res.json().catch(() => ({}));
                            throw new Error(errData.error || 'Update failed');
                        }

                        // Update local state
                        const index = this.scrapedContent.findIndex(c => c.id === this.editingScraped.id);
                        if (index !== -1) {
                            this.scrapedContent[index].description = this.editingScraped.description;
                        }
                        alert('Description saved!');
                        this.editingScraped = null;

                    } catch (e) {
                        console.error('Save scraped description error:', e);
                        alert('Failed to save description: ' + e.message);
                    }
                },
                async sendMedia() {
                    if (this.isUploading) {
                        console.log('Upload already in progress. Ignoring click.');
                        return;
                    }
                    console.log('Starting media upload.');
                    this.isUploading = true;
                    this.uploadStatus = { type: 'info', message: 'Uploading...' };
                    let successCount = 0;
                    
                    for (const item of this.mediaStaging) {
                        const formData = new FormData();
                        formData.append('file', item.file);
                        formData.append('description', item.description || ''); 
                        
                        try {
                            const res = await fetch('/api/portal/upload', { 
                                method: 'POST', 
                                headers: { 'x-portal-token': this.token }, 
                                body: formData 
                            });
                            if (res.ok) successCount++;
                        } catch (e) {
                            console.error('Upload failed for item', e);
                        }
                    }
                    
                    this.mediaStaging = [];
                    this.isMediaEditorOpen = false;
                    this.uploadStatus = { type: 'success', message: `Uploaded ${successCount} items.` };
                    this.isUploading = false;
                    this.fetchMedia();
                },
                async fetchMedia() {
                    this.loading = true;
                    try {
                        const res = await fetch('/api/portal/media', { headers: { 'x-portal-token': this.token } });
                        if (res.ok) {
                            this.mediaFiles = await res.json();
                        }
                    } catch (e) { console.error(e); } finally { this.loading = false; }
                },
                async deleteMedia(file) {
                    // No confirmation dialog, as requested.
                    try {
                        const res = await fetch('/api/portal/media/delete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'x-portal-token': this.token },
                            body: JSON.stringify({ 
                                id: file.id,
                                fileName: file.name // Fallback/Legacy
                            })
                        });
                        if (res.ok) {
                            this.fetchMedia();
                        } else {
                            alert('Failed to delete file.');
                        }
                    } catch (e) { 
                        alert('An error occurred while trying to delete the file.'); 
                    }
                },
                async handleInstaScrape() {
                    this.loading = true;
                    this.error = null;
                    this.scrapeMessage = null;

                    const cleanUsername = this.form.insta_username.replace(/^@/, '').trim();

                    if (!cleanUsername) {
                        this.error = 'Please enter an Instagram username';
                        this.loading = false;
                        return;
                    }

                    try {
                        // 1. Check if account is public first
                        this.scrapeMessage = { type: 'info', text: 'ÿπŸÖ ŸÜÿ™ÿ≠ŸÇŸÇ ÿ•ÿ∞ÿß ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿπÿßŸÖ... | Checking if account is public...' };
                        const checkRes = await fetch('/api/portal/instagram/check-public', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'x-portal-token': this.token },
                            body: JSON.stringify({ username: cleanUsername })
                        });

                        const checkData = await checkRes.json();

                        if (!checkRes.ok || !checkData.isPublic) {
                            this.scrapeMessage = { type: 'error', text: checkData.error || 'Account is private or not found' };
                            this.loading = false;
                            return;
                        }

                        // 2. Save password to profile if provided (for admin-managed rehab)
                        if (this.form.insta_password) {
                            await fetch('/api/portal/profile', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'x-portal-token': this.token },
                                body: JSON.stringify({
                                    instagram_handle: cleanUsername,
                                    ig_password_provided: true
                                })
                            });
                        }

                        // 3. Trigger scrape
                        this.scrapeMessage = { type: 'info', text: 'ÿπŸÖ ŸÜÿ¨ŸÑÿ® ÿßŸÑŸÖŸÑŸÅ... ŸÖŸÖŸÉŸÜ ŸäÿßÿÆÿØ ŸÉŸÖ ÿØŸÇŸäŸÇÿ© | Scraping profile...' };

                        const scrapeRes = await fetch('/api/portal/instagram/scrape', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'x-portal-token': this.token },
                            body: JSON.stringify({ username: cleanUsername })
                        });

                        const scrapeData = await scrapeRes.json();

                        if (scrapeData.cooldown) {
                            this.scrapeMessage = { type: 'error', text: scrapeData.error };
                            this.scrapeStatus.minutesRemaining = scrapeData.minutesRemaining;
                            this.loading = false;
                            return;
                        }

                        if (!scrapeRes.ok) {
                            this.scrapeMessage = { type: 'error', text: scrapeData.error || 'Scrape failed' };
                            this.loading = false;
                            return;
                        }

                        // 4. Success - poll for results until profile pic is available
                        this.scrapeMessage = { type: 'success', text: 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ¨ŸÑÿ®... ŸÖŸÖŸÉŸÜ ŸäÿßÿÆÿØ 2-3 ÿØŸÇÿßŸäŸÇ | Scraping in progress...' };

                        // Poll every 5 seconds until profile pic appears (max 3 minutes)
                        const pollInterval = 5000;
                        const maxPolls = 36; // 3 minutes
                        let pollCount = 0;

                        const pollForResults = async () => {
                            pollCount++;
                            await this.fetchScrapedProfile();

                            // Check if profile pic is now available
                            if (this.scrapedProfile?.profile_pic_url) {
                                this.scrapeMessage = { type: 'success', text: 'ÿ™ŸÖ ÿ¨ŸÑÿ® ÿßŸÑŸÖŸÑŸÅ ÿ®ŸÜÿ¨ÿßÿ≠! | Profile scraped!' };
                                setTimeout(() => { this.scrapeMessage = null; }, 3000);
                                return;
                            }

                            // Keep polling if not at max
                            if (pollCount < maxPolls) {
                                this.scrapeMessage = { type: 'success', text: `ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ¨ŸÑÿ®... (${pollCount * 5}s) | Scraping...` };
                                setTimeout(pollForResults, pollInterval);
                            } else {
                                // Timeout - show what we have
                                this.scrapeMessage = { type: 'warning', text: 'ÿßŸÑÿ¨ŸÑÿ® ŸÖŸÖŸÉŸÜ ŸÑÿ≥ÿß ÿ¥ÿ∫ÿßŸÑ. ÿ≠ÿØÿ´ ÿßŸÑÿµŸÅÿ≠ÿ© | Refresh to see updates' };
                                setTimeout(() => { this.scrapeMessage = null; }, 5000);
                            }
                        };

                        // Start polling after initial delay
                        setTimeout(pollForResults, pollInterval);

                    } catch (e) {
                        console.error('Scrape error:', e);
                        this.scrapeMessage = { type: 'error', text: 'ÿÆÿ∑ÿ£ ÿ®ÿßŸÑÿßÿ™ÿµÿßŸÑ. ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ´ÿßŸÜŸäÿ© | Connection error' };
                    } finally {
                        this.loading = false;
                    }
                },
                async backupFollowers() {
                    this.backupLoading = true;
                    this.backupMessage = null;

                    try {
                        const res = await fetch('/api/portal/instagram/backup-followers', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'x-portal-token': this.token },
                            body: JSON.stringify({ postsToScan: 10 })
                        });

                        const data = await res.json();

                        if (!res.ok) {
                            this.backupMessage = { type: 'error', text: data.error || 'Backup failed' };
                            return;
                        }

                        this.engagedFollowersCount = data.engagedFollowersSaved || 0;
                        this.backupMessage = { type: 'success', text: `ÿ™ŸÖ ŸÜÿ≥ÿÆ ${data.engagedFollowersSaved} ŸÖÿ™ÿßÿ®ÿπ! | ${data.engagedFollowersSaved} followers backed up!` };
                        setTimeout(() => { this.backupMessage = null; }, 5000);

                    } catch (e) {
                        console.error('Backup error:', e);
                        this.backupMessage = { type: 'error', text: 'ÿÆÿ∑ÿ£ ÿ®ÿßŸÑÿßÿ™ÿµÿßŸÑ | Connection error' };
                    } finally {
                        this.backupLoading = false;
                    }
                },
                async fetchEngagedFollowersCount() {
                    try {
                        const res = await fetch('/api/portal/instagram/engaged-followers-count', {
                            headers: { 'x-portal-token': this.token }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            this.engagedFollowersCount = data.count || 0;
                        }
                    } catch (e) {
                        console.error('Fetch engaged followers count error:', e);
                    }
                },
                async fetchScrapedProfile() {
                    try {
                        const res = await fetch('/api/portal/instagram/profile', {
                            headers: { 'x-portal-token': this.token }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            this.scrapedProfile = data.profile;
                            this.scrapeStatus = {
                                canScrape: data.canScrape,
                                minutesRemaining: data.minutesRemaining
                            };
                            // Fetch content if we have a profile
                            if (data.profile) {
                                await this.fetchScrapedContent();
                                await this.fetchEngagedFollowersCount();
                            }
                        }
                    } catch (e) {
                        console.error('Fetch scraped profile error:', e);
                    }
                },
                async fetchScrapedContent() {
                    try {
                        const res = await fetch('/api/portal/instagram/content?limit=9', {
                            headers: { 'x-portal-token': this.token }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            this.scrapedContent = data.content || [];
                        }
                    } catch (e) {
                        console.error('Fetch scraped content error:', e);
                    }
                },
                formatScrapeDate(dateStr) {
                    if (!dateStr) return '';
                    const d = new Date(dateStr);
                    const month = (d.getMonth() + 1).toString().padStart(2, '0'); // 01-12
                    const day = d.getDate().toString().padStart(2, '0');
                    const hours = d.getHours().toString().padStart(2, '0');
                    const mins = d.getMinutes().toString().padStart(2, '0');
                    return `${day}/${month}ÿå ${hours}:${mins}`;
                },
                async unlinkInstagram() {
                    if (!confirm('Unlink this Instagram account? This will remove scraped profile and content data.\n\nÿ•ŸÑÿ∫ÿßÿ° ÿ±ÿ®ÿ∑ Ÿáÿ∞ÿß ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿü ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä ŸàÿßŸÑŸÖÿ≠ÿ™ŸàŸâ.')) {
                        return;
                    }

                    this.loading = true;
                    try {
                        const res = await fetch('/api/portal/instagram/unlink', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'x-portal-token': this.token }
                        });

                        const data = await res.json();

                        if (!res.ok) {
                            throw new Error(data.error || 'Unlink failed');
                        }

                        // Reset local state
                        this.scrapedProfile = null;
                        this.scrapedContent = [];
                        this.scrapeStatus = { canScrape: true, hoursRemaining: 0 };
                        this.form.insta_username = '';
                        this.form.insta_password = '';

                        // Clear profile pic from profile
                        if (this.profile) {
                            this.profile.instagram_handle = null;
                            this.profile.profile_pic_url = null;
                        }

                        this.scrapeMessage = { type: 'success', text: 'Instagram account unlinked successfully' };
                        setTimeout(() => { this.scrapeMessage = null; }, 3000);

                    } catch (e) {
                        console.error('Unlink error:', e);
                        this.error = e.message;
                    } finally {
                        this.loading = false;
                    }
                },
                async handleInstaLogin() {
                    // Legacy login method - kept for admin/fallback use
                    this.loading = true; this.error = null;
                    try {
                        const cleanUsername = this.form.insta_username.replace(/^@/, '');
                        const res = await fetch('/api/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'x-portal-token': this.token },
                            body: JSON.stringify({ username: cleanUsername, password: this.form.insta_password })
                        });
                        const data = await res.json();
                        if (data.status === 'SUCCESS') {
                            alert('Connected!');
                            this.showInstaLogin = false;
                            setTimeout(() => this.fetchProfile(), 1000); // Wait 1s for DB to sync
                        }
                        else if (data.status === '2FA_REQUIRED') this.step = '2fa';
                        else this.error = data.error || 'Login failed';
                    } catch (e) { this.error = 'Connection error. Please try again.'; } finally { this.loading = false; }
                },
                async handle2FA() {
                    this.loading = true; this.error = null;
                    try {
                        const res = await fetch('/api/2fa', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: this.form.username, code: this.form.code }) });
                        const data = await res.json();
                        if (data.status === 'SUCCESS') { this.step = 'dashboard'; this.tab = 'instagram'; this.showInstaLogin = false; this.fetchProfile(); }
                        else this.error = data.error || 'Verification failed';
                    } catch (e) { this.error = 'Connection error'; } finally { this.loading = false; }
                }
            }
        }).mount('#app')
    </script>
</body>
</html>