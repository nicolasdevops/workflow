<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaza Protocol - Family Connect</title>
    <meta property="og:title" content="Gaza Protocol - Family Connect">
    <meta property="og:description" content="Secure family registration portal">
    <meta property="og:type" content="website">
    <meta property="og:image" content="/og-image.png">
    <meta name="twitter:card" content="summary_large_image">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Asap+Condensed:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Hide spin buttons for number inputs */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen bg-gray-100">
        <!-- Navy Header Bar -->
        <div class="w-full bg-[#3274B5] text-white h-20 flex items-center pl-4 pr-2 md:pl-[37px] md:pr-[11px] shadow-md relative">
            <div class="text-3xl md:text-4xl whitespace-nowrap" style="font-family: 'Asap Condensed', sans-serif; letter-spacing: 0.03em;">[D|H<span style="letter-spacing: calc(0.03em + 1px)">|S]</span></div>
            <div class="ml-3 md:ml-6 text-sm opacity-90 font-light border-l border-white/30 pl-3 md:pl-6 h-16 flex flex-col justify-center">
                <div class="font-bold text-[9px] md:text-xs leading-tight md:leading-none mb-[3.5px] whitespace-nowrap tracking-tight">[72H] ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± | Test Group Login</div>
                <div class="font-bold text-[10px] leading-none">System Active | v2.7.3</div>
            </div>
            <button v-if="profile.email" @click="signOut" class="absolute bottom-[9px] right-[20.5px] md:right-[40px] text-white hover:text-gray-200 text-[8px] border border-white px-2 py-0 rounded transition flex items-center justify-center gap-1 h-[18px]">
                <span class="text-[10px] leading-none pb-[2px]">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</span>
            </button>
        </div>

        <div class="flex flex-col items-center justify-start p-4 pt-3" style="min-height: calc(100vh - 7rem);">
        
        <!-- Mobile User Bar (Aligned with Card) -->
        <div class="max-w-2xl w-full flex justify-between items-end mb-3 px-1" v-if="profile.email">
            <div class="flex items-center gap-2 mb-[3px]">
                <img v-if="profile.profile_pic_url" :src="profile.profile_pic_url" class="w-8 h-8 rounded-full border-2 border-[#3274B5] object-cover">
                <div v-else class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-xs font-bold text-gray-600">
                    {{ (profile.name || profile.family_name || 'F')[0].toUpperCase() }}
                </div>
                <div class="text-xs font-bold text-gray-700">{{ profile.name || profile.family_name || profile.email }}</div>
            </div>
            <div class="grid grid-cols-[auto_auto_auto] text-[9px] text-[#3274B5] leading-tight items-baseline">
                <span class="text-right text-[10px]">ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡</span>
                <span class="text-left text-[8px] pl-1">AI Comments</span>
                <span class="font-mono text-right pl-[19px]">{{ profile.comments_count || 0 }}</span>

                <span class="text-right text-[10px]">Ø±Ø³Ø§Ø¦Ù„ Ù…Ø±Ø³Ù„Ø©</span>
                <span class="text-left text-[8px] pl-1">DMs Sent</span>
                <span class="font-mono text-right pl-[19px]">{{ profile.dms_count || 0 }}</span>

                <span class="text-right text-[10px]">Ø±ÙŠÙ„Ø² Ù…Ù†Ø´Ø£Ø©</span>
                <span class="text-left text-[8px] pl-1">Reels Created</span>
                <span class="font-mono text-right pl-[19px]">{{ profile.reels_count || 0 }}</span>

                <span class="text-right text-[10px]">Ø£ÙŠØ§Ù… Ø§Ù„Ù†Ø´Ø§Ø·</span>
                <span class="text-left text-[8px] pl-1">Active Days</span>
                <span class="font-mono text-right pl-[19px]">{{ getRunningTime() }}</span>
            </div>
        </div>

        <div class="max-w-2xl w-full bg-white rounded-2xl shadow-lg p-4 md:p-8">
            
            <!-- Header -->
            <div class="text-center mb-[29px]">
                <h1 class="text-xl text-[#3274B5] uppercase tracking-wide leading-none" style="font-family: 'Oswald', sans-serif;">Test Group Portal</h1>
                <p class="text-gray-500 text-xs uppercase mt-[2px]" style="font-family: 'Roboto Mono', monospace; letter-spacing: 0.18em;">Secure Environment</p>
            </div>

            <!-- Success State -->
            <div v-if="step === 'success'" class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                    <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900">Connected Successfully</h3>
                <p class="text-sm text-gray-500 mt-2">Your account is now linked securely. You can close this page.</p>
            </div>

            <!-- Portal Login -->
            <div v-if="step === 'portal_login'" class="w-full max-w-[350px] mx-auto">
                <div class="flex border-b border-[#3274B5] mb-6">
                    <button @click="authMode = 'register'" :class="{'border-b-2 border-[#3274B5] font-bold': authMode === 'register'}" class="flex-1 pt-2 pb-[11px] text-gray-600 text-sm text-left">1. Register | ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
                    <div class="w-px h-5 bg-[#3274B5] self-center"></div>
                    <button @click="authMode = 'login'" :class="{'border-b-2 border-[#3274B5] font-bold': authMode === 'login'}" class="flex-1 pt-2 pb-[11px] text-gray-600 text-sm text-right">2. Login | ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                </div>

                <form @submit.prevent="authMode === 'login' ? handlePortalLogin() : handlePortalRegister()">
                    <div v-if="authMode === 'register'" class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Family Name | Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</label>
                        <input v-model="form.family_name" type="text" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="e.g. Al-Masri Family | Ù…Ø«Ø§Ù„: Ø¹Ø§Ø¦Ù„Ø© Ø§Ù„Ù…ØµØ±ÙŠ">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Email Address | Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                        <input v-model="form.email" type="email" pattern="[^@\s]+@[^@\s]+\.[^@\s]+" title="Must be a valid email address" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="family@example.com">
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Password | ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                        <input v-model="form.password" type="password" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    </div>
                    <div v-if="authMode === 'login'" class="mb-6 text-right">
                        <button type="button" @click="step = 'forgot_password'" class="text-xs text-[#3274B5] hover:underline">Forgot Password? | Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</button>
                    </div>
                    <button :disabled="loading" type="submit" class="w-auto px-4 mx-auto block bg-[#3274B5] text-white font-bold py-2 rounded-lg hover:bg-[#285e94] transition flex justify-center items-center text-sm gap-1">
                        <span v-if="!loading && authMode === 'login'" class="flex items-center gap-1">Enter Portal | <span class="text-base">Ø¯Ø®ÙˆÙ„</span></span>
                        <span v-if="!loading && authMode === 'register'" class="flex items-center gap-1">Create Account | <span class="text-base">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</span></span>
                        <div v-if="loading" class="loader"></div>
                    </button>
                </form>
            </div>

            <!-- Forgot Password -->
            <div v-if="step === 'forgot_password'" class="w-full max-w-[350px] mx-auto">
                <h3 class="text-lg font-bold text-center mb-4">Reset Password</h3>
                <p class="text-sm text-gray-600 mb-6 text-center">Enter your email address and we'll send you a link to reset your password.</p>
                <form @submit.prevent="handleForgotPassword">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Email Address</label>
                        <input v-model="form.email" type="email" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <button :disabled="loading" type="submit" class="w-full bg-[#3274B5] text-white font-bold py-2 rounded-lg hover:bg-[#285e94] transition flex justify-center items-center text-sm mb-4">
                        <span v-if="!loading">Send Reset Link</span>
                        <div v-else class="loader"></div>
                    </button>
                    <button type="button" @click="step = 'portal_login'" class="w-full text-gray-500 text-sm">Back to Login</button>
                </form>
            </div>

            <!-- Reset Password (New Password Input) -->
            <div v-if="step === 'reset_password'" class="w-full max-w-[350px] mx-auto">
                <h3 class="text-lg font-bold text-center mb-4">Create New Password</h3>
                <form @submit.prevent="handleResetPassword">
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">New Password</label>
                        <input v-model="form.password" type="password" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    </div>
                    <button :disabled="loading" type="submit" class="w-full bg-[#3274B5] text-white font-bold py-2 rounded-lg hover:bg-[#285e94] transition flex justify-center items-center text-sm">
                        <span v-if="!loading">Update Password</span>
                        <div v-else class="loader"></div>
                    </button>
                </form>
            </div>

            <!-- Dashboard -->
            <div v-if="step === 'dashboard'">
                <!-- Admin Impersonation Banner -->
                <div v-if="isImpersonating" class="bg-purple-600 text-white text-center py-2 px-4 mb-4 rounded-lg max-w-[350px] mx-auto flex items-center justify-between">
                    <span class="text-sm font-medium">ğŸ‘ï¸ Viewing as: {{ profile?.name || profile?.email }}</span>
                    <button @click="signOut" class="text-xs bg-white/20 px-2 py-1 rounded hover:bg-white/30">Exit</button>
                </div>

                <div class="flex border-b mb-6 w-full max-w-[350px] mx-auto">
                    <button @click="tab = 'profile'" class="flex-1 px-1 md:px-4 py-2 font-medium text-gray-600 text-sm md:text-lg flex flex-col items-center transition-all">
                        <div class="flex flex-col items-center">
                            <svg class="w-5 h-5" :class="tab === 'profile' ? 'text-[#3274B5]' : 'text-black'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            <span class="whitespace-nowrap" :class="{'text-[#3274B5]': tab === 'profile'}">Ø­Ø³Ø§Ø¨ÙŠ</span>
                        </div>
                    </button>
                    <div class="w-px h-[0.7cm] bg-[#3274B5] self-center"></div>
                    <button @click="tab = 'instagram'" class="flex-1 px-1 md:px-4 py-2 font-medium text-gray-600 text-sm md:text-lg flex flex-col items-center transition-all">
                        <div class="flex flex-col items-center">
                            <svg class="w-5 h-5" :class="tab === 'instagram' ? 'text-[#3274B5]' : 'text-black'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            <span class="whitespace-nowrap" :class="{'text-[#3274B5]': tab === 'instagram'}">Ø§Ù†Ø³ØªØºØ±Ø§Ù…</span>
                        </div>
                    </button>
                    <div class="w-px h-[0.7cm] bg-[#3274B5] self-center"></div>
                    <button @click="tab = 'media'" class="flex-1 px-1 md:px-4 py-2 font-medium text-gray-600 text-sm md:text-lg flex flex-col items-center transition-all">
                        <div class="flex flex-col items-center">
                            <svg class="w-5 h-5" :class="tab === 'media' ? 'text-[#3274B5]' : 'text-black'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            <span class="whitespace-nowrap" :class="{'text-[#3274B5]': tab === 'media'}">Ø±ÙØ¹ Ù…ÙŠØ¯ÙŠØ§</span>
                        </div>
                    </button>
                    <div class="w-px h-[0.7cm] bg-[#3274B5] self-center"></div>
                    <button @click="tab = 'ai'" class="flex-1 px-1 md:px-4 py-2 font-medium text-gray-600 text-sm md:text-lg flex flex-col items-center transition-all">
                        <div class="flex flex-col items-center">
                            <svg class="w-5 h-5" :class="tab === 'ai' ? 'text-[#3274B5]' : 'text-black'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                            <span class="whitespace-nowrap" :class="{'text-[#3274B5]': tab === 'ai'}">Ø°ÙƒØ§Ø¡ ØµÙ†Ø¹ÙŠ</span>
                        </div>
                    </button>
                </div>

                <!-- Tab: Profile -->
                <div v-if="tab === 'profile'" class="w-full max-w-[350px] mx-auto">
                    <!-- Profile Header with Image -->
                    <div class="flex items-center gap-4 mb-[20px] px-4 py-3 bg-gray-50 rounded-lg border border-gray-100">
                        <img v-if="profile.profile_pic_url" :src="profile.profile_pic_url" class="w-16 h-16 rounded-full border-2 border-[#3274B5] object-cover">
                        <div v-else class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center text-gray-400 text-xl font-bold">?</div>
                        <div class="flex-1">
                            <p class="font-bold text-lg leading-tight">{{ profile.name || profile.family_name || 'Family Profile' }} <span class="font-normal text-xs text-gray-500">({{ profile.email }})</span></p>
                            <!-- IG username: always visible -->
                            <div class="mt-1.5">
                                <label class="block text-xs font-bold mb-1 text-[#3274B5]">Ø§Ø³Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ù†Ø³ØªØºØ±Ø§Ù… | IG username</label>
                                <div class="flex gap-1.5 items-center">
                                    <input v-model="igUsernameInput" @keyup.enter="saveIgUsername" type="text" class="flex-1 border p-1.5 rounded text-xs" :class="{'border-red-500 border-2': igUsernameMissing}" placeholder="@username">
                                    <button type="button" @click="saveIgUsername" class="text-[#3274B5] font-bold text-lg leading-none hover:text-[#285e94] px-1">&rsaquo;</button>
                                </div>
                                <p v-if="igUsernameMissing" class="text-red-500 text-xs mt-0.5">Ù…Ø·Ù„ÙˆØ¨ | Required</p>
                                <p v-if="igScrapeProgress" class="text-xs text-[#3274B5] mt-1">{{ igScrapeProgress }}</p>
                            </div>
                        </div>
                    </div>

                    <form @submit.prevent="updateProfile">
                        <div class="grid grid-cols-2 gap-4">
                                                        <div class="mb-1">
                                                            <label class="block text-sm font-bold mb-[6px] flex flex-row items-center justify-center gap-2 text-[#3274B5]">
                                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                                                                <span class="text-sm text-black">Ù†ÙˆØ¹ Ø§Ù„Ø³ÙƒÙ†</span>
                                                            </label>
                                                            <select v-model="profile.housing_type" class="mx-auto block border py-0 px-2 rounded text-sm h-[32px]" style="width: calc(66.666667% - 20px);">
                                                                <option style="font-size: 14px;" value="tent">â›º Ø®ÙŠÙ…Ø©</option>
                                                                <option style="font-size: 14px;" value="school">ğŸ« Ù…Ø¯Ø±Ø³Ø©</option>
                                                                <option style="font-size: 14px;" value="damaged_home">ğŸšï¸ Ø¨ÙŠØª Ù…ØªØ¶Ø±Ø±</option>
                                                                <option style="font-size: 14px;" value="open_air">ğŸ’€ Ø¨Ø§Ù„Ø¹Ø±Ø§Ø¡</option>
                                                            </select>
                                                        </div>
                                                        <div class="mb-1">
                                                            <label class="block text-sm font-bold mb-[6px] flex flex-row items-center justify-center gap-2 text-[#3274B5]">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 9l3 3m0 0l-3 3m3-3H8m13 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                                                <span class="text-sm text-black">Ù…Ø±Ø§Øª Ø§Ù„Ù†Ø²ÙˆØ­</span>
                                                            </label>
                                                            <input v-model="profile.displacement_count" type="number" class="mx-auto block border p-1 rounded text-sm h-[32px]" style="width: calc(66.666667% - 20px);">
                                                        </div>
                                                    </div>
                                                    <div class="grid grid-cols-2 gap-4">
                                                        <div class="mb-1">
                                                            <label class="block text-sm font-bold mb-[6px] flex flex-row items-center justify-center gap-2 text-[#3274B5]">
                                                                <span class="text-sm">ğŸ“</span>
                                                                <span class="text-sm text-black">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</span>
                                                            </label>
                                                            <select v-model="profile.gaza_zone" class="mx-auto block border py-0 px-2 rounded text-sm h-[32px]" style="width: calc(66.666667% - 20px);">
                                                                <option value="" disabled>Ø§Ø®ØªØ±...</option>
                                                                <option value="rafah">Ø±ÙØ­ | Rafah</option>
                                                                <option value="khan_younis">Ø®Ø§Ù† ÙŠÙˆÙ†Ø³ | Khan Younis</option>
                                                                <option value="deir_al_balah">Ø¯ÙŠØ± Ø§Ù„Ø¨Ù„Ø­ | Deir al-Balah</option>
                                                                <option value="gaza_city">Ù…Ø¯ÙŠÙ†Ø© ØºØ²Ø© | Gaza City</option>
                                                                <option value="jabalia">Ø¬Ø¨Ø§Ù„ÙŠØ§ | Jabalia</option>
                                                                <option value="beit_hanoun">Ø¨ÙŠØª Ø­Ø§Ù†ÙˆÙ† | Beit Hanoun</option>
                                                                <option value="nuseirat">Ø§Ù„Ù†ØµÙŠØ±Ø§Øª | Nuseirat</option>
                                                                <option value="bureij">Ø§Ù„Ø¨Ø±ÙŠØ¬ | Bureij</option>
                                                            </select>
                                                        </div>
                                                        <div class="mb-1">
                                                            <label class="block text-sm font-bold mb-[6px] flex flex-row items-center justify-center gap-2 text-[#3274B5]">
                                                                <span class="text-sm">ğŸ•Šï¸</span>
                                                                <span class="text-sm text-black">Ø§Ù„Ø¯ÙŠØ§Ù†Ø©</span>
                                                            </label>
                                                            <select v-model="profile.religion" class="mx-auto block border py-0 px-2 rounded text-sm h-[32px]" style="width: calc(66.666667% - 20px);">
                                                                <option value="" disabled>Ø§Ø®ØªØ±...</option>
                                                                <option value="muslim">Ù…Ø³Ù„Ù… | Muslim</option>
                                                                <option value="christian">Ù…Ø³ÙŠØ­ÙŠ | Christian</option>
                                                            </select>
                                                        </div>
                                                    </div>

                                                    <!-- Children Details Section -->
                                                    <div class="mb-6 border-t pt-4">
                                                        <label class="block text-sm font-bold mb-[10px] flex items-baseline gap-1">
                                                            <span class="text-base text-[#3274B5]">Ø£ÙØ±Ø§Ø¯ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</span>
                                                            <span class="text-xs text-[#3274B5]">({{ profile.children_details?.length || 0 }})</span>
                                                            <span class="text-xs">Family Members</span>
                                                        </label>
                                                        
                                                        <!-- Add new child form -->
                                                        <div class="bg-blue-50 p-3 rounded border border-blue-100">
                                                            <div class="mb-2 flex items-baseline gap-1 font-bold">
                                                                <span class="text-base text-[#3274B5]">Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¯</span>
                                                                <span class="text-xs">| Add Member</span>
                                                            </div>
                                <div class="grid grid-cols-3 gap-2 mb-2">
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                                            <span class="text-xs">ğŸ‘¤</span>
                                        </div>
                                        <input v-model="newMember.name" @input="newMember.name = newMember.name.replace(/[0-9]/g, '')" id="memberNameInput" type="text" placeholder="Ø§Ù„Ø§Ø³Ù… *" autocomplete="off" :class="['border py-0 pl-8 pr-2 rounded text-sm placeholder:text-base w-full h-[30px]', showValidationError && !newMember.name ? 'border-red-500 placeholder:text-red-500' : 'placeholder:text-black']">
                                    </div>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                                            <span class="text-xs">ğŸ‚</span>
                                        </div>
                                        <input v-model="newMember.age" type="text" inputmode="numeric" placeholder="Ø§Ù„Ø¹Ù…Ø± *" @input="checkAgeArabic" :class="['border py-0 pl-8 pr-2 rounded text-sm placeholder:text-base w-full h-[30px]', showValidationError && !newMember.age ? 'border-red-500 placeholder:text-red-500' : 'placeholder:text-black', showAgeArabicError ? 'border-red-500' : '']">
                                        <p v-if="showAgeArabicError" class="text-red-500 text-[10px] mt-0.5 leading-tight">Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¹Ù…Ø± Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØºØ±Ø¨ÙŠØ© | Please write age using Western numerals (0-9)</p>
                                    </div>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                                            <span class="text-xs">ğŸ‘«</span>
                                        </div>
                                        <select v-model="newMember.gender" class="border py-0 pl-8 pr-1 rounded text-sm w-full h-[30px]">
                                            <option value="Male">Ø°ÙƒØ± â™‚</option>
                                            <option value="Female">Ø£Ù†Ø«Ù‰ â™€</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                                            <span class="text-xs">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span>
                                        </div>
                                        <select v-model="newMember.relationship" :class="['border py-0 pl-8 pr-1 rounded text-sm w-full h-[30px] appearance-none bg-white', showValidationError && !newMember.relationship ? 'border-red-500 text-red-500' : '']">
                                            <option value="" disabled selected>ØµÙ„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¨Ø© *</option>
                                            <option value="Son/Daughter">Ø§Ø¨Ù†/Ø§Ø¨Ù†Ø©</option>
                                            <option value="Husband/Wife">Ø²ÙˆØ¬/Ø²ÙˆØ¬Ø©</option>
                                            <option value="Brother/Sister">Ø£Ø®/Ø£Ø®Øª</option>
                                            <option value="Mother/Father">Ø£Ù…/Ø£Ø¨</option>
                                            <option value="Nephew/Niece">Ø§Ø¨Ù† Ø£Ø®/Ø¨Ù†Øª Ø£Ø®Øª</option>
                                            <option value="Aunt/Uncle">Ø¹Ù…Ø©ØŒ Ø®Ø§Ù„Ø©/Ø¹Ù…ØŒ Ø®Ø§Ù„</option>
                                        </select>
                                    </div>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                                            <span class="text-xs">ğŸ©µ</span>
                                        </div>
                                        <select v-model="newMember.status" :class="['border py-0 pl-8 pr-1 rounded text-sm w-full h-[30px] appearance-none bg-white', showValidationError && !newMember.status ? 'border-red-500 text-red-500' : '']">
                                            <option value="" disabled selected>Ø¹Ù„Ù‰ Ù‚ÙŠØ¯ Ø§Ù„Ø­ÙŠØ§Ø©ØŸ *</option>
                                            <option value="Alive">Ø­ÙŠ ÙŠØ±Ø²Ù‚</option>
                                            <option value="Deceased">Ù…ØªÙˆÙÙŠ</option>
                                            <option value="Unknown">Ù…Ø¬Ù‡ÙˆÙ„</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                                            <span class="text-xs">â³</span>
                                        </div>
                                        <input
                                            :value="newMember.status === 'Deceased' ? newMember.days_deceased : newMember.days_missing"
                                            @input="newMember.status === 'Deceased' ? (newMember.days_deceased = $event.target.value) : (newMember.days_missing = $event.target.value)"
                                            type="number"
                                            :placeholder="newMember.status === 'Deceased' ? 'Ø£ÙŠØ§Ù… Ø§Ù„ÙˆÙØ§Ø©' : (newMember.status === 'Unknown' ? 'Ø£ÙŠØ§Ù… Ø§Ù„ÙÙ‚Ø¯Ø§Ù†' : 'Ø£ÙŠØ§Ù…')"
                                            :disabled="!newMember.status || newMember.status === 'Alive'"
                                            class="border py-0 pl-8 pr-2 rounded text-sm w-full h-[30px] disabled:bg-gray-100 disabled:text-gray-400 disabled:cursor-not-allowed"
                                        >
                                    </div>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                                            <span class="text-xs">ğŸ©º</span>
                                        </div>
                                        <input v-model="newMember.condition" type="text" placeholder="Ø­Ø§Ù„Ø© ØµØ­ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" class="border py-0 pl-8 pr-2 rounded text-sm placeholder:text-sm placeholder:text-black w-full h-[30px]">
                                    </div>
                                </div>
                                <div class="grid grid-cols-[3fr_1fr_2fr] gap-2 mb-0">
                                    <div class="flex items-center gap-3 h-[30px]">
                                        <label class="flex items-center gap-1 cursor-pointer">
                                            <input type="radio" v-model="newMember.disability" value="no" class="accent-[#3274B5]">
                                            <span class="text-xs">Ù„Ø£</span>
                                        </label>
                                        <label class="flex items-center gap-1 cursor-pointer">
                                            <input type="radio" v-model="newMember.disability" value="yes" class="accent-[#3274B5]">
                                            <span class="text-xs">Ø¢Ù‡</span>
                                        </label>
                                        <span class="text-lg text-black whitespace-nowrap">Ø¥Ø¹Ø§Ù‚Ø© ØŸ</span>
                                    </div>
                                    <div></div>
                                    <div class="flex items-center gap-2 justify-end">
                                        <button type="button" @click="addMember" class="px-2 py-0.5 bg-[#3274B5] text-white font-bold rounded-lg hover:bg-[#285e94] transition flex justify-center items-center text-xs gap-1 h-[26px] flex-shrink-0">
                                            <span>+ Add | </span>
                                            <span class="text-base">Ø¥Ø¶Ø§ÙØ©</span>
                                        </button>
                                        <svg v-if="memberSaved" class="w-6 h-6 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                                    </div>
                                </div>
                            </div>
                        </div>

                                                        <!-- List of added children -->
                                                        <div v-if="profile.children_details && profile.children_details.length > 0" class="mb-4 space-y-2">
                                                            <div v-for="(member, index) in profile.children_details" :key="index" class="bg-gray-50 rounded border text-sm relative">
                                                                <!-- Ã— delete: top-right corner -->
                                                                <button type="button" @click="removeChild(index)" class="absolute top-1 right-1 text-gray-300 hover:text-gray-500 text-sm leading-none px-1">Ã—</button>
                                                                <!-- Summary content -->
                                                                <div class="p-2 pr-6" dir="ltr" style="text-align: left;">
                                                                    <span style="display: flex; gap: 0.25rem; align-items: center;">
                                                                        <span class="text-xs" dir="auto">{{ member.nameDisplay || member.name }}</span>
                                                                        <span class="text-xs" dir="ltr">|</span>
                                                                        <span class="text-xs" dir="ltr">{{ (getRelationshipLabel(member.relationship, member.gender) || {en: 'Member', ar: ''}).en }}</span>
                                                                        <span dir="rtl">{{ (getRelationshipLabel(member.relationship, member.gender) || {en: 'Member', ar: ''}).ar }}</span>
                                                                        <span class="text-xs" dir="ltr">|</span>
                                                                        <span class="text-xs" dir="ltr">{{ member.gender === 'Male' ? 'â™‚' : 'â™€' }}</span>
                                                                        <span class="text-xs" dir="ltr">|</span>
                                                                        <span class="text-xs" dir="ltr">{{ member.age }}</span>
                                                                    </span>
                                                                    <div class="text-xs text-gray-500" style="display: flex; gap: 0.25rem; align-items: center; flex-wrap: wrap;">
                                                                        <template v-if="member.status">
                                                                            <span class="text-xs" dir="ltr" :class="{'text-[#3274B5]': member.status === 'Alive'}">{{ getStatusLabel(member.status).en }}</span>
                                                                            <span dir="rtl" :class="{'text-[#3274B5]': member.status === 'Alive'}">{{ getStatusLabel(member.status).ar }}</span>
                                                                            <span v-if="member.status === 'Deceased' && member.days_deceased" class="text-xs" dir="ltr">| {{ member.days_deceased }} days</span>
                                                                            <span v-if="member.status === 'Unknown' && member.days_missing" class="text-xs" dir="ltr">| {{ member.days_missing }} days</span>
                                                                        </template>
                                                                        <span v-if="member.condition" dir="auto">| {{ member.conditionDisplay || member.condition }}</span>
                                                                        <span v-if="member.disability === 'yes'" class="inline-flex items-center gap-1">|
                                                                            <img src="icons/disability-7.png" style="width: 19px; height: 19px; mix-blend-mode: multiply;" class="object-contain inline-block" title="Disabled">
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                                <!-- AMAP button: bottom-right corner -->
                                                                <button type="button" @click="toggleMemberDetails(index)" class="absolute bottom-1 right-1 p-0.5 rounded hover:bg-gray-200" title="ØªÙØ§ØµÙŠÙ„">
                                                                    <img src="icons/detail-panel.png" style="width: 13px; height: 13px; opacity: 0.18; transition: opacity 0.2s;" class="object-contain group-hover:opacity-60" onmouseover="this.style.opacity='0.6'" onmouseout="this.style.opacity='0.18'">
                                                                </button>
                                                                <!-- Detail popup overlay -->
                                                                <div v-show="member.detailsOpen" class="fixed inset-0 z-50 flex items-center justify-center overflow-hidden" style="background: rgba(0,0,0,0.4); backdrop-filter: blur(2px);" @click.self="toggleMemberDetails(index)">
                                                                <!-- Popup wrapper: close button outside panel, not scrollable -->
                                                                <div class="relative mx-4 max-w-md w-full" @click.stop>
                                                                    <button type="button" @click="toggleMemberDetails(index)" class="absolute -top-7 right-0 text-white hover:text-gray-300 text-2xl leading-none z-10">&times;</button>
                                                                <div class="bg-white/95 rounded-3xl p-4 max-h-[80vh] overflow-y-auto shadow-2xl" style="overscroll-behavior: contain;" dir="rtl">
                                                                    <!-- Popup header: name left -->
                                                                    <div class="mb-3" dir="ltr">
                                                                        <span class="text-sm font-bold text-[#3274B5]">{{ member.nameDisplay || member.name }}</span>
                                                                    </div>
                                                                    <!-- Row 1: Medical condition + Physical state -->
                                                                    <div class="grid grid-cols-2 gap-3 mb-2">
                                                                        <div>
                                                                            <label class="block text-xs font-bold mb-1 text-[#3274B5]">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ©</label>
                                                                            <select v-model="member.medical_condition" @change="updateProfile()" class="w-full border py-0 px-2 rounded text-xs h-[28px]">
                                                                                <option value="">â€”</option>
                                                                                <option value="none">Ù„Ø§ Ø´ÙŠØ¡ | None</option>
                                                                                <option value="cerebral_palsy">Ø´Ù„Ù„ Ø¯Ù…Ø§ØºÙŠ | Cerebral palsy</option>
                                                                                <option value="heart_defect">Ø¹ÙŠØ¨ Ù‚Ù„Ø¨ÙŠ | Heart defect</option>
                                                                                <option value="diabetes">Ø³ÙƒØ±ÙŠ | Diabetes</option>
                                                                                <option value="malnutrition">Ø³ÙˆØ¡ ØªØºØ°ÙŠØ© | Malnutrition</option>
                                                                                <option value="respiratory">ØªÙ†ÙØ³ÙŠ | Respiratory</option>
                                                                                <option value="amputee">Ø¨ØªØ± | Amputee</option>
                                                                                <option value="burns">Ø­Ø±ÙˆÙ‚ | Burns</option>
                                                                                <option value="fracture">ÙƒØ³Ø± | Fracture</option>
                                                                                <option value="infection">Ø§Ù„ØªÙ‡Ø§Ø¨ | Infection</option>
                                                                                <option value="other">Ø£Ø®Ø±Ù‰ | Other</option>
                                                                            </select>
                                                                        </div>
                                                                        <div>
                                                                            <label class="block text-xs font-bold mb-1 text-[#3274B5]">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ©</label>
                                                                            <select v-model="member.physical_state" @change="updateProfile()" class="w-full border py-0 px-2 rounded text-xs h-[28px]">
                                                                                <option value="">â€”</option>
                                                                                <option value="healthy">Ø³Ù„ÙŠÙ… | Healthy</option>
                                                                                <option value="thin">Ù†Ø­ÙŠÙ | Thin</option>
                                                                                <option value="malnourished">Ù†Ø§Ù‚Øµ ØªØºØ°ÙŠØ© | Malnourished</option>
                                                                                <option value="emaciated">Ù‡Ø²ÙŠÙ„ | Emaciated</option>
                                                                                <option value="injured">Ù…ØµØ§Ø¨ | Injured</option>
                                                                            </select>
                                                                        </div>
                                                                    </div>
                                                                    <!-- Row 2: Mobility + Cognitive -->
                                                                    <div class="grid grid-cols-2 gap-3 mb-2">
                                                                        <div>
                                                                            <label class="block text-xs font-bold mb-1 text-[#3274B5]">Ø§Ù„Ø­Ø±ÙƒØ©</label>
                                                                            <select v-model="member.mobility" @change="updateProfile()" class="w-full border py-0 px-2 rounded text-xs h-[28px]">
                                                                                <option value="">â€”</option>
                                                                                <option value="full">ÙƒØ§Ù…Ù„Ø© | Full</option>
                                                                                <option value="limited">Ù…Ø­Ø¯ÙˆØ¯Ø© | Limited</option>
                                                                                <option value="wheelchair">ÙƒØ±Ø³ÙŠ Ù…ØªØ­Ø±Ùƒ | Wheelchair</option>
                                                                                <option value="immobile">ØºÙŠØ± Ù‚Ø§Ø¯Ø± | Immobile</option>
                                                                            </select>
                                                                        </div>
                                                                        <div>
                                                                            <label class="block text-xs font-bold mb-1 text-[#3274B5]">Ø§Ù„Ø¥Ø¯Ø±Ø§Ùƒ</label>
                                                                            <select v-model="member.cognitive" @change="updateProfile()" class="w-full border py-0 px-2 rounded text-xs h-[28px]">
                                                                                <option value="">â€”</option>
                                                                                <option value="typical">Ø·Ø¨ÙŠØ¹ÙŠ | Typical</option>
                                                                                <option value="delayed">ØªØ£Ø®Ø± | Delayed</option>
                                                                                <option value="nonverbal">ØºÙŠØ± Ù„ÙØ¸ÙŠ | Nonverbal</option>
                                                                            </select>
                                                                        </div>
                                                                    </div>
                                                                    <!-- Row 3: Medical detail (full width) -->
                                                                    <div class="mb-2">
                                                                        <label class="block text-xs font-bold mb-1 text-[#3274B5]">ØªÙØ§ØµÙŠÙ„ Ø·Ø¨ÙŠØ©</label>
                                                                        <input v-model="member.medical_detail" @blur="updateProfile()" type="text" class="w-full border py-0 px-2 rounded text-xs h-[28px]" placeholder="Ù…Ø«Ø§Ù„: Ø«Ù‚Ø¨ ÙÙŠ Ø§Ù„Ù‚Ù„Ø¨ØŒ ÙŠØ­ØªØ§Ø¬ Ø¨Ø®Ø§Ø®">
                                                                    </div>
                                                                    <!-- Row 4: Medication name + cost + remaining -->
                                                                    <div class="grid grid-cols-3 gap-3 mb-2">
                                                                        <div>
                                                                            <label class="block text-xs font-bold mb-1 text-[#3274B5]">Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡</label>
                                                                            <input v-model="member.medication_name" @blur="updateProfile()" type="text" class="w-full border py-0 px-2 rounded text-xs h-[28px]">
                                                                        </div>
                                                                        <div>
                                                                            <label class="block text-xs font-bold mb-1 text-[#3274B5]">ØªÙƒÙ„ÙØ© â‚ª</label>
                                                                            <input v-model="member.medication_cost" @blur="updateProfile()" type="number" class="w-full border py-0 px-2 rounded text-xs h-[28px]">
                                                                        </div>
                                                                        <div>
                                                                            <label class="block text-xs font-bold mb-1 text-[#3274B5]">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</label>
                                                                            <input v-model="member.medication_remaining" @blur="updateProfile()" type="text" class="w-full border py-0 px-2 rounded text-xs h-[28px]">
                                                                        </div>
                                                                    </div>
                                                                    <!-- Row 5: Clothing description (full width) -->
                                                                    <div class="mb-2">
                                                                        <label class="block text-xs font-bold mb-1 text-[#3274B5]">ÙˆØµÙ Ø§Ù„Ù…Ù„Ø§Ø¨Ø³</label>
                                                                        <input v-model="member.clothing_description" @blur="updateProfile()" type="text" class="w-full border py-0 px-2 rounded text-xs h-[28px]" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ù„ÙˆØ²Ø© Ø±Ù…Ø§Ø¯ÙŠØ© ÙƒØ¨ÙŠØ±Ø©ØŒ Ø¨Ù†Ø·Ù„ÙˆÙ† Ù…Ù…Ø²Ù‚">
                                                                    </div>
                                                                    <!-- Row 6: Clothing photos -->
                                                                    <div class="mb-2" dir="ltr">
                                                                        <label class="block text-xs font-bold mb-1 text-[#3274B5]">Clothing | ØµÙˆØ± Ø§Ù„Ù…Ù„Ø§Ø¨Ø³</label>
                                                                        <input type="file" multiple accept="image/*" @change="handleMemberFileUpload($event, index, 'clothing_photos')" class="w-full text-xs">
                                                                        <div v-if="member.clothing_photos && member.clothing_photos.length" class="flex gap-2 mt-2 flex-wrap">
                                                                            <div v-for="(url, pi) in member.clothing_photos" :key="pi" class="relative group">
                                                                                <img :src="url" @click="previewFile = { url: url, metadata: { mimetype: 'image/jpeg' } }" class="w-16 h-16 object-cover rounded-lg border shadow-sm cursor-pointer hover:opacity-80 transition">
                                                                                <button type="button" @click="removeMemberFile(index, 'clothing_photos', pi)" class="absolute -top-1.5 -right-1.5 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center shadow opacity-0 group-hover:opacity-100 transition">&times;</button>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <!-- Row 7: Photos of [Name] -->
                                                                    <div class="mb-2" dir="ltr">
                                                                        <label class="block text-xs font-bold mb-1 text-[#3274B5]">Pictures of {{ member.name }}</label>
                                                                        <input type="file" multiple accept="image/*" @change="handleMemberFileUpload($event, index, 'photo_refs')" class="w-full text-xs">
                                                                        <div v-if="member.photo_refs && member.photo_refs.length" class="flex gap-2 mt-2 flex-wrap">
                                                                            <div v-for="(url, pi) in member.photo_refs" :key="pi" class="relative group">
                                                                                <img :src="url" @click="previewFile = { url: url, metadata: { mimetype: 'image/jpeg' } }" class="w-16 h-16 object-cover rounded-lg border shadow-sm cursor-pointer hover:opacity-80 transition">
                                                                                <button type="button" @click="removeMemberFile(index, 'photo_refs', pi)" class="absolute -top-1.5 -right-1.5 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center shadow opacity-0 group-hover:opacity-100 transition">&times;</button>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <!-- Row 8: Videos of [Name] -->
                                                                    <div class="mb-2" dir="ltr">
                                                                        <label class="block text-xs font-bold mb-1 text-[#3274B5]">Videos of {{ member.name }}</label>
                                                                        <input type="file" multiple accept="video/*" @change="handleMemberFileUpload($event, index, 'video_refs')" class="w-full text-xs">
                                                                        <div v-if="member.video_refs && member.video_refs.length" class="flex gap-2 mt-2 flex-wrap">
                                                                            <div v-for="(url, vi) in member.video_refs" :key="vi" class="relative group">
                                                                                <div @click="previewFile = { url: url, metadata: { mimetype: 'video/mp4' } }" class="w-16 h-16 bg-gray-800 rounded-lg border shadow-sm cursor-pointer hover:opacity-80 transition flex items-center justify-center">
                                                                                    <span class="text-white text-lg">â–¶</span>
                                                                                </div>
                                                                                <button type="button" @click="removeMemberFile(index, 'video_refs', vi)" class="absolute -top-1.5 -right-1.5 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center shadow opacity-0 group-hover:opacity-100 transition">&times;</button>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <!-- Row 9: Notes (full width) -->
                                                                    <div class="mb-3">
                                                                        <label class="block text-xs font-bold mb-1 text-[#3274B5]">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                                                                        <textarea v-model="member.notes" @blur="updateProfile()" class="w-full border py-1 px-2 rounded text-xs" rows="2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
                                                                    </div>
                                                                    <!-- Save button (matches base form style) -->
                                                                    <button type="button" @click="saveMemberDetails(index)" class="px-3 py-1 bg-[#3274B5] text-white font-bold rounded-lg hover:bg-[#285e94] transition flex justify-center items-center text-xs gap-1 h-[30px] mx-auto">
                                                                        <span class="text-base">Ø­ÙØ¸</span>
                                                                        <span class="opacity-80">|</span>
                                                                        <span>Save</span>
                                                                    </button>
                                                                </div><!-- /popup content (scrollable) -->
                                                                </div><!-- /popup wrapper (close btn) -->
                                                                </div><!-- /popup overlay -->
                                                            </div><!-- /member card -->
                                                        </div><!-- /member list -->

                        <!-- Urgent Needs Section -->
                        <div class="mb-6 border-t pt-4">
                            <label class="block mb-1 flex items-baseline gap-1 font-bold">
                                <span class="text-base text-[#3274B5]">Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª Ø¹Ø§Ø¬Ù„Ø©</span>
                                <span class="text-xs">| Urgent Needs</span>
                            </label>
                            
                            <div class="mb-4 flex gap-2">
                                <select v-model="newUrgentNeed" class="w-full border py-0 px-2 rounded text-base h-[30px]">
                                    <option value="" disabled>Ø§Ø®ØªØ± Ø§Ø­ØªÙŠØ§Ø¬...</option>
                                    <option v-for="opt in urgentNeedOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
                                </select>
                                <div class="flex items-center gap-2">
                                    <button type="button" @click="addUrgentNeed" :disabled="!newUrgentNeed" class="px-2 py-0.5 bg-[#3274B5] text-white font-bold rounded-lg hover:bg-[#285e94] transition flex justify-center items-center text-xs disabled:cursor-not-allowed gap-1 h-[26px] whitespace-nowrap flex-shrink-0">
                                        <span>Add</span>
                                        <span class="text-[10px] text-white/70">|</span>
                                        <span class="text-base">Ø¥Ø¶Ø§ÙØ©</span>
                                    </button>
                                    <svg v-if="urgentNeedSaved" class="w-6 h-6 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                                </div>
                            </div>

                            <!-- List of added needs -->
                            <div v-if="profile.urgent_needs && profile.urgent_needs.length > 0" class="mb-4 space-y-2">
                                <div v-for="(need, index) in profile.urgent_needs" :key="index" class="flex justify-between items-center bg-gray-50 px-2 py-1 rounded border h-[30px]">
                                    <span class="text-sm">
                                        <span>{{ getUrgentNeedLabel(need).split('|')[0] }}</span>
                                        <span v-if="getUrgentNeedLabel(need).includes('|')" class="text-xs text-gray-600"> | {{ getUrgentNeedLabel(need).split('|')[1] }}</span>
                                    </span>
                                    <button type="button" @click="removeUrgentNeed(index)" class="text-gray-300 hover:text-gray-500 px-2 text-sm">Ã—</button>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="block text-xs text-black mb-1 flex items-baseline gap-1 font-bold">
                                    <span class="text-base text-[#3274B5]">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</span>
                                    <span>| Cash Amount Needed</span>
                                </label>
                                <input v-model="profile.urgent_need_amount" type="text" class="w-[60%] border p-2 rounded text-sm h-[30px]" style="width: calc(60% + 4px);" placeholder="e.g. $500">
                            </div>
                        </div>

                        <!-- PalPay Wallet Section -->
                        <div class="mb-6 border-t pt-4">
                            <div class="mb-4">
                                <label class="block text-xs text-black mb-1 flex items-baseline gap-1 font-bold">
                                    <span class="text-base text-[#3274B5]">Ø±Ù‚Ù… Ù…Ø­ÙØ¸Ø© Ø¨Ø§Ù„Ø¨Ø§ÙŠ ØºØ²Ø©</span>
                                    <span class="text-[10px]">| Gaza PalPay Wallet phone number</span>
                                </label>
                                <input v-model="profile.palpay_phone" type="tel" class="w-full border p-2 rounded text-sm h-[30px]" placeholder="e.g. 0599123456">
                            </div>
                            <div class="mb-4">
                                <label class="block text-xs text-black mb-1 flex items-baseline gap-1 font-bold">
                                    <span class="text-base text-[#3274B5]">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„Ù…Ø­ÙØ¸Ø©</span>
                                    <span class="text-[10px]">| Full name as registered on Wallet</span>
                                </label>
                                <input v-model="profile.palpay_name" type="text" class="w-full border p-2 rounded text-sm h-[30px]" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
                            </div>
                        </div>

                        <button type="submit" class="px-3 py-1 bg-[#3274B5] text-white font-bold rounded-lg hover:bg-[#285e94] transition flex justify-center items-center text-xs gap-1 h-[30px] mx-auto">
                            <span class="text-base">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù</span>
                            <span class="opacity-80">|</span>
                            <span>Save</span>
                        </button>
                    </form>
                </div>

                <!-- Tab: Media -->
                <div v-if="tab === 'media'">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg px-8 py-4 text-center mb-6">
                        <input type="file" multiple @change="handleFileUpload" class="hidden" id="fileInput" accept="image/*,video/*">
                        <label for="fileInput" class="cursor-pointer block group hover:text-[#3274B5] transition-colors">
                            <div class="text-black group-hover:text-[#3274B5] leading-tight text-center">
                                <div class="text-base font-bold mb-3">ØµÙˆØ± ÙˆÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙÙŠØ¯ÙŠÙˆ Ø±ÙŠÙ„Ø² Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ. Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ù„Ø±ÙØ¹</div>
                                <div class="text-sm">Photos and Videos For AI Reel Generation. Click to Upload</div>
                            </div>
                        </label>
                    </div>
                    <div v-if="uploadStatus" class="mb-4 text-sm text-center" :class="uploadStatus.type === 'success' ? 'text-green-600' : 'text-red-600'">
                        {{ uploadStatus.message }}
                    </div>

                    <!-- Media Gallery -->
                    <div v-if="mediaFiles.length > 0" class="grid grid-cols-3 gap-2">
                        <div v-for="file in mediaFiles" :key="file.id" class="relative group aspect-square bg-gray-100 rounded overflow-hidden border border-gray-200">
                            <!-- Clickable Area for Preview -->
                            <div @click="previewFile = file" class="w-full h-full cursor-pointer">
                                <img v-if="file.metadata.mimetype.startsWith('image')" :src="file.url" class="w-full h-full object-cover">
                                <div v-else class="w-full h-full relative">
                                    <video :src="file.url + '#t=0.5'" class="w-full h-full object-cover bg-gray-900 pointer-events-none" preload="metadata" muted playsinline></video>
                                    <div class="absolute top-1 right-1 bg-black/60 rounded-full p-1 pointer-events-none">
                                        <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"/></svg>
                                    </div>
                                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                        <div class="bg-black/30 rounded-full p-2">
                                            <svg class="w-8 h-8 text-white opacity-80" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/></svg>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Delete Button (Bottom Right) - visible on hover -->
                            <button @click.stop="deleteMedia(file)" class="absolute bottom-1 right-1 bg-red-600 text-white p-1.5 rounded-full hover:bg-red-700 shadow-sm opacity-0 group-hover:opacity-100 transition z-10">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>

                            <!-- Edit/Info Button (Bottom Left) - visible on hover -->
                            <button @click.stop="openEditMedia(file)" title="Edit Text Description | ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØµÙ" class="absolute bottom-1 left-1 bg-green-600 text-white p-1.5 rounded-full hover:bg-green-700 shadow-sm opacity-0 group-hover:opacity-100 transition z-10">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div v-else-if="!loading" class="text-center text-gray-400 text-sm mt-4">
                        No media uploaded yet.
                    </div>
                    <div v-if="loading" class="flex justify-center mt-4"><div class="loader"></div></div>
                </div>

                <!-- Tab: Instagram (Apify Scraper Flow) -->
                <div v-if="tab === 'instagram'">
                    <!-- Scraped Profile Display -->
                    <div v-if="scrapedProfile" class="bg-[#3274B5]/10 border border-[#3274B5]/30 p-3 rounded-lg mb-3 relative">
                        <!-- Unlink X Button -->
                        <button @click="unlinkInstagram" class="absolute top-2 right-2 text-[#3274B5] hover:text-red-500 transition p-1 rounded-full hover:bg-red-50" title="Unlink Instagram | Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø¨Ø·">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                        <div class="flex items-start gap-3">
                            <img v-if="scrapedProfile.profile_pic_url" :src="scrapedProfile.profile_pic_url" class="w-16 h-16 rounded-full border-2 border-[#3274B5] object-cover">
                            <div v-else class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center text-gray-400 text-xl font-bold">?</div>
                            <div class="flex-1">
                                <div class="flex items-center gap-2 text-[#3274B5] font-bold mb-1">
                                    <div class="w-2 h-2 bg-[#3274B5] rounded-full animate-pulse"></div>
                                    <span class="text-base">ØªÙ… Ø§Ù„Ø¬Ù„Ø¨</span>
                                </div>
                                <p class="text-xs text-gray-600">@{{ scrapedProfile.instagram_username }}</p>
                                <p v-if="scrapedProfile.full_name" class="text-xs text-gray-600">{{ scrapedProfile.full_name }}</p>
                                <div class="flex gap-3 text-xs text-gray-500 mt-1">
                                    <span class="flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                        <span>{{ scrapedProfile.followers_count?.toLocaleString() || 0 }} Ù…ØªØ§Ø¨Ø¹</span>
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                        <span>{{ scrapedProfile.posts_count || 0 }} Ù…Ù†Ø´ÙˆØ±</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-[10px]">Ø¢Ø®Ø± ÙØ­Øµ {{ formatScrapeDate(scrapedProfile.last_scraped_at) }}</p>
                    </div>

                    <!-- Connected via cookies (legacy) -->
                    <div v-else-if="profile.cookies" class="bg-blue-50 border border-blue-100 p-2 rounded-lg mb-2 flex justify-center">
                        <div class="flex flex-col items-start">
                            <div class="flex items-center gap-2 text-blue-700 font-bold mb-2">
                                <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                                <span class="text-sm tracking-wide">CONNECTED</span>
                                <span class="text-lg">Ù…ØªØµÙ„</span>
                            </div>
                            <p class="text-base font-mono text-gray-800 mb-2">@{{ profile.instagram_handle || profile.handle }}</p>
                            <p class="text-xs text-gray-500">(Admin-managed session)</p>
                        </div>
                    </div>

                    <!-- Not connected -->
                    <div v-else class="bg-yellow-50 p-2 rounded mb-2 text-center">
                        <p class="text-yellow-700 flex justify-center items-baseline gap-1 font-bold">
                            <span class="text-base">Ø§Ù†Ø³ØªØºØ±Ø§Ù… ØºÙŠØ± Ù…ØªØµÙ„</span>
                            <span class="text-xs">| Not Connected</span>
                        </p>
                    </div>

                    <!-- Scrape Form -->
                    <div class="mt-4 border-t pt-4">
                        <form @submit.prevent="handleInstaScrape">
                            <div class="mb-4">
                                <label class="block mb-1 flex flex-col items-start gap-[5px] text-[#3274B5]">
                                    <span class="text-base font-bold leading-none">Ø§Ø³Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ù†Ø³ØªØºØ±Ø§Ù…</span>
                                    <span class="text-xs font-normal leading-none">IG username</span>
                                </label>
                                <input v-model="form.insta_username" type="text" class="w-full border p-2 rounded text-sm" placeholder="e.g. @ahmed_gaza">
                            </div>
                            <div class="mb-4">
                                <label class="block mb-1 flex flex-col items-start gap-[5px] text-[#3274B5]">
                                    <span class="text-base font-bold leading-none">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
                                    <span class="text-xs font-normal leading-none">Password (Optional)</span>
                                </label>
                                <input v-model="form.insta_password" type="password" :disabled="!profile.instagram_password_enabled" class="w-full border border-[#3274B5]/30 bg-[#3274B5]/10 p-2 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                                <p v-if="!profile.instagram_password_enabled" class="text-xs text-gray-500 mt-1 text-right">ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„ØªÙØ¹ÙŠÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</p>
                                <p v-else class="text-xs text-gray-400 mt-1">Password saved for admin-managed account recovery only</p>
                            </div>
                            <button :disabled="loading" type="submit" class="w-auto px-3 mx-auto block bg-[#3274B5] text-white font-bold py-1.5 rounded-lg hover:bg-[#285e94] transition flex justify-center items-center text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                                <span v-if="!loading">{{ scrapedProfile ? 'Rescrape Profile | Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø¨' : 'Scrape Profile | Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„Ù' }}</span>
                                <div v-else class="loader"></div>
                            </button>
                        </form>
                        <p v-if="scrapeMessage" class="text-center text-xs mt-3" :class="scrapeMessage.type === 'success' ? 'text-green-600' : scrapeMessage.type === 'error' ? 'text-red-600' : 'text-blue-600'">
                            {{ scrapeMessage.text }}
                        </p>

                        <!-- Backup Followers Button -->
                        <div v-if="scrapedProfile" class="mt-4 pt-4 border-t border-gray-200" style="padding-bottom: 3px;">
                            <div class="flex items-center justify-between mb-1">
                                <div>
                                    <h4 class="text-sm font-bold text-[#3274B5]">Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†</h4>
                                    <p class="text-xs text-gray-500 mb-1">Backup Engaged Followers</p>
                                </div>
                                <span v-if="engagedFollowersCount" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">
                                    {{ engagedFollowersCount }} backed up
                                </span>
                            </div>
                            <button @click="backupFollowers" disabled class="w-auto px-3 mx-auto block bg-gray-400 text-white font-bold py-1.5 rounded-lg transition flex justify-center items-center text-sm opacity-50 cursor-not-allowed mt-3">
                                <span v-if="!backupLoading">Backup Followers | Ù†Ø³Ø® Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†</span>
                                <div v-else class="loader"></div>
                            </button>
                            <p v-if="backupMessage" class="text-center text-xs mt-2" :class="backupMessage.type === 'success' ? 'text-green-600' : 'text-red-600'">
                                {{ backupMessage.text }}
                            </p>
                        </div>
                    </div>

                    <!-- Scraped Content Preview -->
                    <div v-if="scrapedContent && scrapedContent.length > 0" class="mt-4 mb-4 border-t pt-4" style="padding-bottom: 10px;">
                        <h4 class="text-sm font-bold flex items-baseline gap-1" style="margin-bottom: 10px;">
                            <span class="text-base text-[#3274B5]">Ù…Ø­ØªÙˆÙ‰ Ù…Ø³ØªÙˆØ±Ø¯</span>
                            <span class="text-xs font-normal text-gray-500">| Imported Content ({{ scrapedContent.length }})</span>
                        </h4>
                        <div style="height: 6px;"></div>
                        <div class="grid grid-cols-3 gap-1">
                            <div v-for="item in scrapedContent.slice(0, 9)" :key="item.id" class="relative group aspect-square bg-gray-100 rounded overflow-hidden border border-gray-200">
                                <!-- Clickable Area for Preview -->
                                <div @click="openScrapedPreview(item)" class="w-full h-full cursor-pointer">
                                    <template v-if="item.is_video">
                                        <img v-if="item.display_url" :src="item.display_url" class="w-full h-full object-cover">
                                        <div class="absolute top-1 right-1 bg-black/60 rounded-full p-1 pointer-events-none">
                                            <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"/></svg>
                                        </div>
                                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                            <div class="bg-black/30 rounded-full p-2">
                                                <svg class="w-8 h-8 text-white opacity-80" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/></svg>
                                            </div>
                                        </div>
                                    </template>
                                    <template v-else>
                                        <img v-if="item.display_url" :src="item.display_url" class="w-full h-full object-cover">
                                        <div v-else class="w-full h-full flex items-center justify-center text-gray-400 text-xs">No image</div>
                                    </template>
                                </div>

                                <!-- Edit Button (Bottom Left) - visible on hover -->
                                <button @click.stop="openEditScraped(item)" title="Edit Text Description | ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØµÙ" class="absolute bottom-1 left-1 bg-green-600 text-white p-1.5 rounded-full hover:bg-green-700 shadow-sm opacity-0 group-hover:opacity-100 transition z-10">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: AI Generated Content -->
                <div v-if="tab === 'ai'" class="w-full max-w-[350px] mx-auto">
                    <div class="text-center py-8">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-br from-purple-100 to-blue-100 flex items-center justify-center">
                            <svg class="w-8 h-8 text-[#3274B5]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2">Ù…Ø­ØªÙˆÙ‰ Ø°ÙƒØ§Ø¡ ØµÙ†Ø¹ÙŠ</h3>
                        <p class="text-sm text-gray-500 mb-1">AI Generated Content</p>
                        <p class="text-xs text-gray-400 mt-4">Ù‚Ø±ÙŠØ¨Ø§Ù‹ | Coming Soon</p>
                    </div>
                </div>
            </div>

            <!-- Lightbox Modal -->
            <div v-if="previewFile" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4" @click="previewFile = null">
                <div class="relative max-w-4xl w-full max-h-screen flex flex-col items-center" @click.stop>
                    <button @click="previewFile = null" class="absolute -top-10 right-0 text-white hover:text-gray-300">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                    
                    <img v-if="previewFile.metadata.mimetype.startsWith('image')" :src="previewFile.url" class="max-w-full max-h-[80vh] rounded shadow-2xl">
                    <video v-else :src="previewFile.url" class="max-w-full max-h-[80vh] rounded shadow-2xl" controls autoplay playsinline></video>
                </div>
            </div>

            <!-- 2FA Form -->
            <div v-if="step === '2fa'">
                <p class="text-sm text-gray-600 mb-4 text-center">Instagram sent a code to your phone/email. Please enter it below.</p>
                <form @submit.prevent="handle2FA">
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Security Code</label>
                        <input v-model="form.code" type="text" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-xl tracking-widest" required placeholder="123456">
                    </div>
                    <button :disabled="loading" type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition flex justify-center items-center">
                        <span v-if="!loading">Verify Code</span>
                        <div v-else class="loader"></div>
                    </button>
                </form>
            </div>

            <!-- Media Editor Modal -->
            <div v-if="isMediaEditorOpen" class="fixed inset-0 bg-black/90 z-50 flex flex-col p-4 overflow-y-auto">
                <div class="w-full max-w-2xl mx-auto bg-white rounded-lg shadow-xl p-4 flex-1 flex flex-col">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="font-bold text-lg flex items-center gap-2">
                            <span class="text-[#3274B5]">Add Details</span>
                            <span>| Ø¥Ø¶Ø§ÙØ© ØªÙØ§ØµÙŠÙ„</span>
                        </h3>
                        <button @click="isMediaEditorOpen = false; mediaStaging = []" class="text-gray-500 hover:text-red-500">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto space-y-4">
                        <div v-for="(item, index) in mediaStaging" :key="index" class="flex gap-3 border rounded p-2 relative items-center">
                            <!-- Thumbnail -->
                            <div class="w-24 h-24 flex-shrink-0 bg-gray-100 rounded overflow-hidden relative border border-gray-200">
                                <img v-if="item.type.startsWith('image')" :src="item.url" class="w-full h-full object-cover">
                                <video v-else :src="item.url + '#t=0.5'" class="w-full h-full object-cover bg-gray-900" preload="metadata" playsinline muted></video>
                                <button @click="removeStagedMedia(index)" class="absolute top-0 right-0 bg-red-500 text-white rounded-bl p-1 hover:bg-red-600 z-10">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                            
                            <!-- Description Input -->
                            <div class="flex-1 flex flex-col h-24">
                                <label class="block mb-[2px] leading-tight text-[#3274B5]">
                                    <div class="flex flex-row items-center gap-1 flex-wrap">
                                        <span class="text-sm font-bold whitespace-nowrap">Ø§ÙƒØªØ¨ ÙˆØµÙ</span>
                                    </div>
                                </label>
                                <textarea v-model="item.description" class="w-full border rounded p-2 text-sm flex-1 resize-none focus:ring-2 focus:ring-[#3274B5] focus:outline-none" placeholder="Ø§Ø´Ø±Ø­ Ù…Ø§ ÙŠØ­Ø¯Ø«... | Explain..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t flex justify-center">
                        <button @click="sendMedia" :disabled="isUploading" class="w-auto px-4 bg-[#3274B5] text-white font-bold py-1 rounded-full hover:bg-[#285e94] transition flex justify-center items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed h-[36px]">
                            <span v-if="!isUploading" class="text-lg">Ø¥Ø±Ø³Ø§Ù„</span>
                            <span v-if="!isUploading" class="text-white/50">|</span>
                            <span v-if="!isUploading">Send</span>
                            <div v-else class="loader border-white border-t-transparent"></div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Edit Description Modal -->
            <div v-if="editingFile" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-lg shadow-xl p-4 max-w-lg w-full" @click.stop>
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="font-bold text-lg flex items-center gap-2">
                            <span class="text-[#3274B5]">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„</span>
                            <span>| Edit Details</span>
                        </h3>
                        <button @click="editingFile = null" class="text-gray-500 hover:text-red-500">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-xs font-bold mb-1 flex items-baseline gap-1 text-[#3274B5]">
                            <span class="text-sm">Ø§ÙƒØªØ¨ ÙˆØµÙÙ‹Ø§</span>
                        </label>
                        <textarea v-model="editingFile.description" class="w-full border rounded p-2 text-sm h-32 resize-none focus:ring-2 focus:ring-[#3274B5] focus:outline-none" placeholder="Ø§Ø´Ø±Ø­ Ù…Ø§ ÙŠØ­Ø¯Ø« ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©/Ø§Ù„ÙÙŠØ¯ÙŠÙˆ... | Explain what is happening..."></textarea>
                    </div>

                    <div class="flex justify-end gap-2">
                        <button @click="editingFile = null" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded text-xs">Cancel</button>
                        <button @click="saveMediaDescription" class="w-auto px-3 py-1 bg-[#3274B5] text-white font-bold rounded-lg hover:bg-[#285e94] transition flex justify-center items-center text-xs gap-1 h-[30px]">
                            <span>Save | </span>
                            <span class="text-base">Ø­ÙØ¸</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Edit Scraped Content Description Modal -->
            <div v-if="editingScraped" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-lg shadow-xl p-4 max-w-lg w-full" @click.stop>
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="font-bold text-lg flex items-center gap-2">
                            <span class="text-[#3274B5]">ÙˆØµÙ Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø¹ÙŠ</span>
                            <span>| AI Description</span>
                        </h3>
                        <button @click="editingScraped = null" class="text-gray-500 hover:text-red-500">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>

                    <!-- Thumbnail preview -->
                    <div class="flex gap-3 mb-4">
                        <div class="w-20 h-20 flex-shrink-0 bg-gray-100 rounded overflow-hidden border">
                            <img v-if="editingScraped.display_url" :src="editingScraped.display_url" class="w-full h-full object-cover">
                        </div>
                        <div v-if="editingScraped.caption" class="flex-1 text-xs text-gray-500 overflow-hidden line-clamp-3">
                            {{ editingScraped.caption }}
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-xs font-bold mb-1 flex items-baseline gap-1 text-[#3274B5]">
                            <span class="text-sm">Ø§ÙƒØªØ¨ ÙˆØµÙÙ‹Ø§ Ø¥Ø¶Ø§ÙÙŠÙ‹Ø§</span>
                            <span class="text-xs font-normal text-gray-500">| Add context for AI</span>
                        </label>
                        <textarea v-model="editingScraped.description" class="w-full border rounded p-2 text-sm h-32 resize-none focus:ring-2 focus:ring-[#3274B5] focus:outline-none" placeholder="Ø£ÙŠ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ù† Ø§Ù„ØµÙˆØ±Ø©/Ø§Ù„ÙÙŠØ¯ÙŠÙˆ... | Any additional context..."></textarea>
                    </div>

                    <div class="flex justify-end gap-2">
                        <button @click="editingScraped = null" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded text-xs">Cancel</button>
                        <button @click="saveScrapedDescription" class="w-auto px-3 py-1 bg-[#3274B5] text-white font-bold rounded-lg hover:bg-[#285e94] transition flex justify-center items-center text-xs gap-1 h-[30px]">
                            <span>Save | </span>
                            <span class="text-base">Ø­ÙØ¸</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div v-if="error" class="mt-4 p-3 bg-red-50 text-red-700 text-sm rounded border border-red-200">
                {{ error }}
            </div>

            <div class="mt-6 text-center">
                <p class="text-xs text-gray-400">
                    <span class="inline-block w-2 h-2 bg-green-500 rounded-full mr-1"></span>
                    End-to-End Encrypted
                </p>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() { 
                return { 
                    step: 'portal_login', // portal_login, dashboard, 2fa, success
                    authMode: 'register',
                    tab: sessionStorage.getItem('current_tab') || 'profile',
                    resetToken: null,
                    isImpersonating: false, // True when admin is viewing as this family
                    loading: false,
                    isUploading: false,
                    error: null, 
                    token: null,
                    previewFile: null,
                    showInstaLogin: false,
                    uploadStatus: null,
                    mediaFiles: [],
                    profile: {},
                    mediaStaging: [],
                    isMediaEditorOpen: false,
                    editingFile: null,
                    editingScraped: null,
                    newUrgentNeed: '',
                    newMember: { name: '', age: '', gender: 'Male', relationship: '', status: '', days_deceased: '', days_missing: '', condition: '', disability: '' },
                    scrapedProfile: null,
                    scrapedContent: [],
                    scrapeStatus: { canScrape: true, minutesRemaining: 0 },
                    scrapeMessage: null,
                    backupLoading: false,
                    backupMessage: null,
                    engagedFollowersCount: 0,
                    translationCache: {},
                    memberSaved: false,
                    urgentNeedSaved: false,
                    showValidationError: false,
                    showAgeArabicError: false,
                    igUsernameInput: '',
                    igUsernameMissing: false,
                    igScrapeProgress: '',
                    igScrapeTimer: null,
                    urgentNeedOptions: [
                        { value: "floods", label: "ğŸŒŠ Ù†ÙˆØ§Ø¬Ù‡ ÙÙŠØ¶Ø§Ù†Ø§Øª | Facing severe floods" },
                        { value: "displacement", label: "ğŸš¶ Ø§Ø³ØªÙ„Ù…Ù†Ø§ Ø£Ù…Ø± Ø¥Ø®Ù„Ø§Ø¡ | Displacement order" },
                        { value: "new_tent", label: "ğŸ›– Ø§Ù„Ø®ÙŠÙ…Ø© ØªØ¯Ù…Ø±Øª (Ø¨Ø¯Ù†Ø§ Ø¬Ø¯ÙŠØ¯Ø©) | Bad tent" },
                        { value: "home_repair", label: "ğŸ§± Ø§Ù„Ø¨ÙŠØª Ø¨Ø¯Ùˆ ØªØ±Ù…ÙŠÙ… | Repairs" },
                        { value: "tent_repair", label: "ğŸ› ï¸ Ø§Ù„Ø®ÙŠÙ…Ø© Ø¨Ø¯Ù‡Ø§ ØªØµÙ„ÙŠØ­ | Broken tent" },
                        { value: "tent_tarp", label: "â›º Ø§Ù„Ø®ÙŠÙ…Ø© Ø¨Ø¯Ù‡Ø§ Ø´Ø§Ø¯Ø± | Tarp" },
                        { value: "food", label: "ğŸ² Ø¨Ø­Ø§Ø¬Ø© Ù…Ø§Ø³Ø© Ù„Ø£ÙƒÙ„ | Food" },
                        { value: "medicines", label: "ğŸ’Š Ø¨Ø¯Ù†Ø§ Ø¯ÙˆØ§Ø¡ Ø¶Ø±ÙˆØ±ÙŠ | Medicines" },
                        { value: "blankets", label: "ğŸ§£ Ø¨Ø¯Ù†Ø§ Ø¨Ø·Ø§Ù†ÙŠØ§Øª | Blankets needed" },
                        { value: "clothes", label: "ğŸ§¥ Ø¨Ø¯Ù†Ø§ ÙˆØ§Ø¹ÙŠ Ø´ØªÙˆÙŠ | Clothes" },
                        { value: "medical_op", label: "ğŸ¥ ØªÙƒØ§Ù„ÙŠÙ Ø¹Ù…Ù„ÙŠØ© | Operation" },
                        { value: "medical_consult", label: "ğŸ©º Ø§Ø³ØªØ´Ø§Ø±Ø© Ø·Ø¨ÙŠØ© Ø¹Ø§Ø¬Ù„Ø© | Consultation" },
                        { value: "rent", label: "ğŸ’µ Ø¹Ù„ÙŠÙ†Ø§ Ø¥ÙŠØ¬Ø§Ø± Ù…ØªØ£Ø®Ø± | Rent arrears overdue" },
                        { value: "evacuation", label: "ğŸšŒ ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø³ÙØ± Ù„Ù…ØµØ± | Egypt" },
                        { value: "business_setup", label: "ğŸ’¼ ØªÙƒØ§Ù„ÙŠÙ ØªØ£Ø³ÙŠØ³ Ù…Ø´Ø±ÙˆØ¹ | Business" },
                        { value: "campaign", label: "ğŸ’» Ø¯Ø¹Ù… Ø§Ù„Ø­Ù…Ù„Ø© | Financing" },
                        { value: "other", label: "â“ Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª ØªØ§Ù†ÙŠØ© | Necessities" }
                    ],
                    form: { email: '', family_name: '', password: '', instagram_handle: '', insta_username: '', insta_password: '', code: '' } 
                } 
            },
            watch: {
                tab(newTab, oldTab) {
                    // Validate IG username before leaving profile tab
                    if (oldTab === 'profile' && !this.profile.instagram_handle && !this.igUsernameInput.trim()) {
                        this.igUsernameMissing = true;
                        this.tab = 'profile';
                        return;
                    }
                    sessionStorage.setItem('current_tab', newTab);
                    if (newTab === 'media') this.fetchMedia();
                    if (newTab === 'instagram') this.fetchScrapedProfile();
                }
            },
            mounted() {
                // Check for admin impersonation token in URL first
                const urlParams = new URLSearchParams(window.location.search);
                const impersonateToken = urlParams.get('impersonate');
                if (impersonateToken) {
                    // Admin is viewing as this family - use impersonation token
                    this.token = impersonateToken;
                    this.isImpersonating = true;
                    sessionStorage.setItem('portal_token', impersonateToken);
                    this.step = 'dashboard';
                    this.fetchProfile();
                    this.fetchScrapedProfile();
                    // Clean URL (remove impersonate param)
                    window.history.replaceState({}, document.title, "/");
                    return;
                }

                // Check for local token (SessionStorage for tab persistence only)
                const localToken = sessionStorage.getItem('portal_token');
                if (localToken) {
                    this.token = localToken;
                    this.step = 'dashboard';

                    // Restore active tab
                    const savedTab = sessionStorage.getItem('current_tab');
                    if (savedTab) this.tab = savedTab;

                    this.fetchProfile();
                    this.fetchScrapedProfile(); // Always load scraped Instagram data

                    // If restoring directly to media tab, fetch media immediately
                    if (this.tab === 'media') this.fetchMedia();
                }

                // Check for reset token in URL
                const resetToken = urlParams.get('token');
                if (resetToken) {
                    this.resetToken = resetToken;
                    this.step = 'reset_password';
                    // Clean URL
                    window.history.replaceState({}, document.title, "/");
                }
            },
            methods: {
                getRunningTime() {
                    if (!this.profile.created_at) return '0';
                    const start = new Date(this.profile.created_at);
                    const now = new Date();
                    const diff = now - start;
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    return `${days}`;
                },
                signOut() {
                    this.token = null;
                    this.profile = {};
                    this.step = 'portal_login';
                    this.authMode = 'login';
                    sessionStorage.removeItem('portal_token');
                    sessionStorage.removeItem('current_tab');
                },
                async handlePortalLogin() {
                    this.loading = true; this.error = null;
                    try {
                        const res = await fetch('/api/portal/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: this.form.email, password: this.form.password })
                        });
                        const data = await res.json();
                        if (data.error) throw new Error(data.error);
                        
                        this.token = data.token;
                        sessionStorage.setItem('portal_token', data.token);
                        this.profile = data.user;
                        this.form.insta_username = data.user.handle || ''; // Pre-fill if exists
                        this.step = 'dashboard';
                        this.fetchProfile(); // Get full details
                        this.fetchScrapedProfile(); // Load scraped Instagram data
                    } catch (e) { this.error = e.message; } finally { this.loading = false; }
                },
                async handlePortalRegister() {
                    this.loading = true; this.error = null;
                    try {
                        const res = await fetch('/api/portal/register', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: this.form.email, password: this.form.password, family_name: this.form.family_name })
                        });
                        const data = await res.json();
                        if (data.error) throw new Error(data.error);
                        
                        this.token = data.token;
                        sessionStorage.setItem('portal_token', data.token);
                        this.profile = data.user;
                        this.step = 'dashboard';
                        this.fetchProfile(); // Get full details
                    } catch (e) { this.error = e.message; } finally { this.loading = false; }
                },
                async handleForgotPassword() {
                    this.loading = true; this.error = null;
                    try {
                        await fetch('/api/portal/forgot-password', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: this.form.email })
                        });
                        alert('If an account exists, a reset link has been sent to your email (Check Server Console for link).');
                        this.step = 'portal_login';
                    } catch (e) { this.error = 'Request failed'; } finally { this.loading = false; }
                },
                async handleResetPassword() {
                    this.loading = true; this.error = null;
                    try {
                        const res = await fetch('/api/portal/reset-password', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ token: this.resetToken, newPassword: this.form.password })
                        });
                        if (res.ok) { alert('Password updated! Please login.'); this.step = 'portal_login'; }
                        else throw new Error('Invalid or expired token');
                    } catch (e) { this.error = e.message; } finally { this.loading = false; }
                },
                async fetchProfile() {
                    try {
                        const res = await fetch('/api/portal/me', { headers: { 'x-portal-token': this.token } });
                        if (res.status === 401) {
                            // Token invalid (server restarted or session expired)
                            this.signOut();
                            return;
                        }
                        this.profile = await res.json();
                        // Ensure children_details array exists
                        if (!this.profile.children_details) this.profile.children_details = [];
                        // Ensure urgent_needs array exists
                        if (!this.profile.urgent_needs) this.profile.urgent_needs = [];
                        // Pre-fill Instagram username if available
                        if (this.profile.instagram_handle) {
                            if (!this.form.insta_username) this.form.insta_username = this.profile.instagram_handle;
                            if (!this.igUsernameInput) this.igUsernameInput = this.profile.instagram_handle;
                        }

                        // Reset detail panels and transliterate names for existing members
                        for (const member of this.profile.children_details) {
                            member.detailsOpen = false;
                            if (member.name && !member.nameDisplay) {
                                member.nameDisplay = await this.getTransliteratedName(member.name);
                            }
                            if (member.condition && !member.conditionDisplay) {
                                member.conditionDisplay = await this.getBilingualText(member.condition);
                            }
                        }
                    } catch (e) {
                        console.error('Fetch profile error', e);
                    }
                },
                async saveIgUsername() {
                    if (!this.igUsernameInput.trim()) {
                        this.igUsernameMissing = true;
                        return;
                    }
                    const handle = this.igUsernameInput.replace(/^@/, '').trim();
                    this.profile.instagram_handle = handle;
                    this.form.insta_username = handle;
                    this.igUsernameMissing = false;
                    await this.updateProfile();

                    // Start animated dots
                    let dotCount = 0;
                    this.igScrapeTimer = setInterval(() => {
                        dotCount = (dotCount % 3) + 1;
                        this.igScrapeProgress = '.'.repeat(dotCount);
                    }, 400);

                    try {
                        // 1. Check if public
                        const checkRes = await fetch('/api/portal/instagram/check-public', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'x-portal-token': this.token },
                            body: JSON.stringify({ username: handle })
                        });
                        const checkData = await checkRes.json();
                        if (!checkRes.ok || !checkData.is_public) {
                            clearInterval(this.igScrapeTimer);
                            this.igScrapeProgress = checkData.error || 'Account not public';
                            return;
                        }

                        // 2. Trigger scrape
                        await fetch('/api/portal/instagram/scrape', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'x-portal-token': this.token },
                            body: JSON.stringify({ username: handle })
                        });

                        // 3. Poll for profile pic
                        let polls = 0;
                        const maxPolls = 36; // 3 min
                        const pollForPic = async () => {
                            polls++;
                            await this.fetchScrapedProfile();
                            if (this.scrapedProfile?.profile_pic_url) {
                                this.profile.profile_pic_url = this.scrapedProfile.profile_pic_url;
                                clearInterval(this.igScrapeTimer);
                                this.igScrapeProgress = '';
                                return;
                            }
                            if (polls < maxPolls) {
                                setTimeout(pollForPic, 5000);
                            } else {
                                clearInterval(this.igScrapeTimer);
                                this.igScrapeProgress = '';
                            }
                        };
                        setTimeout(pollForPic, 5000);
                    } catch (e) {
                        clearInterval(this.igScrapeTimer);
                        this.igScrapeProgress = 'Error';
                        console.error('IG scrape from profile:', e);
                    }
                },
                async updateProfile() {
                    // Sync count
                    this.profile.children_count = this.profile.children_details.length;
                    await fetch('/api/portal/profile', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'x-portal-token': this.token },
                        body: JSON.stringify(this.profile)
                    });
                },
                checkAgeArabic() {
                    const arabicNumerals = /[\u0660-\u0669\u06F0-\u06F9]/;
                    if (arabicNumerals.test(this.newMember.age)) {
                        this.showAgeArabicError = true;
                        this.newMember.age = this.newMember.age.replace(arabicNumerals, '');
                    } else {
                        this.showAgeArabicError = false;
                        this.newMember.age = this.newMember.age.replace(/[^0-9]/g, '');
                    }
                },
                async addMember() {
                    // Validate required fields
                    if (!this.newMember.name || !this.newMember.age || !this.newMember.relationship || !this.newMember.status) {
                        // Show validation errors for 4 seconds
                        this.showValidationError = true;
                        setTimeout(() => {
                            this.showValidationError = false;
                        }, 4000);
                        return;
                    }

                    if (!this.profile.children_details) this.profile.children_details = [];

                    // Transliterate name (phonetic) and translate condition (semantic)
                    const memberWithTranslations = { ...this.newMember };
                    // Auto-capitalize name (each word)
                    if (memberWithTranslations.name) {
                        memberWithTranslations.name = memberWithTranslations.name.replace(/\b[a-z]/g, c => c.toUpperCase());
                        memberWithTranslations.nameDisplay = await this.getTransliteratedName(memberWithTranslations.name);
                    }
                    if (memberWithTranslations.condition) {
                        memberWithTranslations.conditionDisplay = await this.getBilingualText(memberWithTranslations.condition);
                    }

                    this.profile.children_details.push(memberWithTranslations);
                    this.newMember = { name: '', age: '', gender: 'Male', relationship: '', status: '', days_deceased: '', days_missing: '', condition: '', disability: '' }; // Reset

                    // Show green checkmark immediately
                    this.memberSaved = true;
                    setTimeout(() => {
                        this.memberSaved = false;
                    }, 5000);

                    // Update profile in background
                    await this.updateProfile();
                },
                async removeChild(index) {
                    this.profile.children_details.splice(index, 1);
                    await this.updateProfile();
                },
                toggleMemberDetails(index) {
                    const member = this.profile.children_details[index];
                    member.detailsOpen = !member.detailsOpen;
                    // Lock/unlock body scroll when popup is open/closed
                    document.body.style.overflow = member.detailsOpen ? 'hidden' : '';
                },
                async handleMemberFileUpload(e, memberIndex, fieldName) {
                    const files = Array.from(e.target.files);
                    if (!files.length) return;
                    const member = this.profile.children_details[memberIndex];
                    const arrayFields = ['clothing_photos', 'photo_refs', 'video_refs'];
                    if (arrayFields.includes(fieldName) && !member[fieldName]) member[fieldName] = [];
                    for (const file of files) {
                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('description', `member_${memberIndex}_${fieldName}`);
                        try {
                            const res = await fetch('/api/portal/upload', {
                                method: 'POST',
                                headers: { 'x-portal-token': this.token },
                                body: formData
                            });
                            if (res.ok) {
                                const data = await res.json();
                                const url = data.url || data.publicUrl || '';
                                if (arrayFields.includes(fieldName)) {
                                    member[fieldName].push(url);
                                } else {
                                    member[fieldName] = url;
                                }
                            }
                        } catch (err) {
                            console.error('Member file upload error:', err);
                        }
                    }
                    await this.updateProfile();
                    e.target.value = '';
                },
                async removeMemberFile(memberIndex, fieldName, fileIndex) {
                    const member = this.profile.children_details[memberIndex];
                    if (member[fieldName]) {
                        member[fieldName].splice(fileIndex, 1);
                        await this.updateProfile();
                    }
                },
                async saveMemberDetails(index) {
                    await this.updateProfile();
                    this.toggleMemberDetails(index);
                },
                async addUrgentNeed() {
                    if (!this.profile.urgent_needs) this.profile.urgent_needs = [];
                    if (!this.profile.urgent_needs.includes(this.newUrgentNeed)) {
                        this.profile.urgent_needs.push(this.newUrgentNeed);
                    }
                    this.newUrgentNeed = '';

                    // Show green checkmark immediately
                    this.urgentNeedSaved = true;
                    setTimeout(() => {
                        this.urgentNeedSaved = false;
                    }, 5000);

                    // Update profile in background
                    await this.updateProfile();
                },
                async removeUrgentNeed(index) {
                    this.profile.urgent_needs.splice(index, 1);
                    await this.updateProfile();
                },
                getUrgentNeedLabel(value) {
                    const option = this.urgentNeedOptions.find(o => o.value === value);
                    return option ? option.label : value;
                },
                getRelationshipLabel(relationship, gender) {
                    const isMale = gender === 'Male';
                    const map = {
                        'Son/Daughter': isMale ? { en: 'Son', ar: 'Ø§Ø¨Ù†' } : { en: 'Daughter', ar: 'Ø§Ø¨Ù†Ø©' },
                        'Husband/Wife': isMale ? { en: 'Husband', ar: 'Ø²ÙˆØ¬' } : { en: 'Wife', ar: 'Ø²ÙˆØ¬Ø©' },
                        'Brother/Sister': isMale ? { en: 'Brother', ar: 'Ø£Ø®' } : { en: 'Sister', ar: 'Ø£Ø®Øª' },
                        'Mother/Father': isMale ? { en: 'Father', ar: 'Ø£Ø¨' } : { en: 'Mother', ar: 'Ø£Ù…' },
                        'Nephew/Niece': isMale ? { en: 'Nephew', ar: 'Ø§Ø¨Ù† Ø£Ø®' } : { en: 'Niece', ar: 'Ø¨Ù†Øª Ø£Ø®Øª' },
                        'Aunt/Uncle': isMale ? { en: 'Uncle', ar: 'Ø¹Ù…ØŒ Ø®Ø§Ù„' } : { en: 'Aunt', ar: 'Ø¹Ù…Ø©ØŒ Ø®Ø§Ù„Ø©' }
                    };
                    return map[relationship] || { en: relationship, ar: '' };
                },
                getStatusLabel(status) {
                    const map = {
                        'Alive': { en: 'Alive', ar: 'Ø­ÙŠ ÙŠØ±Ø²Ù‚' },
                        'Deceased': { en: 'Deceased', ar: 'Ù…ØªÙˆÙÙŠ' },
                        'Unknown': { en: 'Unknown', ar: 'Ù…Ø¬Ù‡ÙˆÙ„' }
                    };
                    return map[status] || { en: status, ar: '' };
                },
                async translateText(text, targetLang = 'en') {
                    if (!text || !text.trim()) return text;

                    // Check cache first
                    const cacheKey = `${text}_${targetLang}`;
                    if (this.translationCache[cacheKey]) {
                        return this.translationCache[cacheKey];
                    }

                    try {
                        const res = await fetch('/api/translate', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-portal-token': this.token
                            },
                            body: JSON.stringify({ text, targetLang })
                        });

                        if (!res.ok) throw new Error('Translation failed');

                        const data = await res.json();
                        // Cache the result
                        this.translationCache[cacheKey] = data.translation;
                        return data.translation;
                    } catch (error) {
                        console.error('Translation error:', error);
                        return text; // Return original text on error
                    }
                },
                async getTransliteratedName(name) {
                    if (!name || !name.trim()) return name;
                    try {
                        const res = await fetch('/api/transliterate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'x-portal-token': this.token },
                            body: JSON.stringify({ text: name })
                        });
                        if (!res.ok) return name;
                        const data = await res.json();
                        const isArabic = /[\u0600-\u06FF]/.test(name);
                        return isArabic ? `${data.transliteration} ${name}` : `${name} ${data.transliteration}`;
                    } catch (e) {
                        return name;
                    }
                },
                async getBilingualText(text) {
                    if (!text || !text.trim()) return text;

                    // Detect if text is primarily Arabic (contains Arabic characters)
                    const isArabic = /[\u0600-\u06FF]/.test(text);

                    if (isArabic) {
                        // Arabic â†’ English
                        const translation = await this.translateText(text, 'en');
                        return `${translation} ${text}`;
                    } else {
                        // English â†’ Arabic
                        const translation = await this.translateText(text, 'ar');
                        return `${text} ${translation}`;
                    }
                },
                async handleFileUpload(e) {
                    const files = Array.from(e.target.files);
                    if (!files.length) return;
                    
                    for (const file of files) {
                        this.mediaStaging.push({
                            file,
                            url: URL.createObjectURL(file),
                            type: file.type,
                            description: ''
                        });
                    }
                    this.isMediaEditorOpen = true;
                    e.target.value = ''; // Reset input
                },
                removeStagedMedia(index) {
                    this.mediaStaging.splice(index, 1);
                    if (this.mediaStaging.length === 0) this.isMediaEditorOpen = false;
                },
                openEditMedia(file) {
                    this.editingFile = { ...file, description: file.metadata?.description || '' };
                },
                async saveMediaDescription() {
                    if (!this.editingFile || !this.editingFile.id) {
                        alert('Error: Missing file ID');
                        return;
                    }

                    try {
                        const res = await fetch('/api/portal/media/update', {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'x-portal-token': this.token 
                            },
                            body: JSON.stringify({ 
                                id: this.editingFile.id,
                                description: this.editingFile.description 
                            })
                        });

                        if (!res.ok) {
                            const errData = await res.json().catch(() => ({}));
                            throw new Error(errData.error || 'Update failed');
                        }

                        // Update local state
                        const index = this.mediaFiles.findIndex(f => f.id === this.editingFile.id);
                        if (index !== -1) {
                            if (!this.mediaFiles[index].metadata) this.mediaFiles[index].metadata = {};
                            this.mediaFiles[index].metadata.description = this.editingFile.description;
                        }
                        alert('Description saved!');
                        this.editingFile = null;

                    } catch (e) {
                        console.error('Save description error:', e);
                        alert('Failed to save description: ' + e.message);
                    }
                },
                openScrapedPreview(item) {
                    // Normalize scraped item to work with existing lightbox
                    this.previewFile = {
                        url: item.is_video && item.video_url ? item.video_url : item.display_url,
                        metadata: {
                            mimetype: item.is_video ? 'video/mp4' : 'image/jpeg'
                        }
                    };
                },
                openEditScraped(item) {
                    this.editingScraped = {
                        id: item.id,
                        short_code: item.short_code,
                        caption: item.caption || '',
                        description: item.description || '',
                        display_url: item.display_url,
                        is_video: item.is_video
                    };
                },
                async saveScrapedDescription() {
                    if (!this.editingScraped || !this.editingScraped.id) {
                        alert('Error: Missing content ID');
                        return;
                    }

                    try {
                        const res = await fetch('/api/portal/instagram/content/update', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-portal-token': this.token
                            },
                            body: JSON.stringify({
                                id: this.editingScraped.id,
                                description: this.editingScraped.description
                            })
                        });

                        if (!res.ok) {
                            const errData = await res.json().catch(() => ({}));
                            throw new Error(errData.error || 'Update failed');
                        }

                        // Update local state
                        const index = this.scrapedContent.findIndex(c => c.id === this.editingScraped.id);
                        if (index !== -1) {
                            this.scrapedContent[index].description = this.editingScraped.description;
                        }
                        alert('Description saved!');
                        this.editingScraped = null;

                    } catch (e) {
                        console.error('Save scraped description error:', e);
                        alert('Failed to save description: ' + e.message);
                    }
                },
                async sendMedia() {
                    if (this.isUploading) {
                        console.log('Upload already in progress. Ignoring click.');
                        return;
                    }
                    console.log('Starting media upload.');
                    this.isUploading = true;
                    this.uploadStatus = { type: 'info', message: 'Uploading...' };
                    let successCount = 0;
                    
                    for (const item of this.mediaStaging) {
                        const formData = new FormData();
                        formData.append('file', item.file);
                        formData.append('description', item.description || ''); 
                        
                        try {
                            const res = await fetch('/api/portal/upload', { 
                                method: 'POST', 
                                headers: { 'x-portal-token': this.token }, 
                                body: formData 
                            });
                            if (res.ok) successCount++;
                        } catch (e) {
                            console.error('Upload failed for item', e);
                        }
                    }
                    
                    this.mediaStaging = [];
                    this.isMediaEditorOpen = false;
                    this.uploadStatus = { type: 'success', message: `Uploaded ${successCount} items.` };
                    this.isUploading = false;
                    this.fetchMedia();
                },
                async fetchMedia() {
                    this.loading = true;
                    try {
                        const res = await fetch('/api/portal/media', { headers: { 'x-portal-token': this.token } });
                        if (res.ok) {
                            this.mediaFiles = await res.json();
                        }
                    } catch (e) { console.error(e); } finally { this.loading = false; }
                },
                async deleteMedia(file) {
                    // No confirmation dialog, as requested.
                    try {
                        const res = await fetch('/api/portal/media/delete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'x-portal-token': this.token },
                            body: JSON.stringify({ 
                                id: file.id,
                                fileName: file.name // Fallback/Legacy
                            })
                        });
                        if (res.ok) {
                            this.fetchMedia();
                        } else {
                            alert('Failed to delete file.');
                        }
                    } catch (e) { 
                        alert('An error occurred while trying to delete the file.'); 
                    }
                },
                async handleInstaScrape() {
                    this.loading = true;
                    this.error = null;
                    this.scrapeMessage = null;

                    const cleanUsername = this.form.insta_username.replace(/^@/, '').trim();

                    if (!cleanUsername) {
                        this.error = 'Please enter an Instagram username';
                        this.loading = false;
                        return;
                    }

                    try {
                        // 1. Check if account is public first
                        this.scrapeMessage = { type: 'info', text: 'Ø¹Ù… Ù†ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¹Ø§Ù…... | Checking if account is public...' };
                        const checkRes = await fetch('/api/portal/instagram/check-public', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'x-portal-token': this.token },
                            body: JSON.stringify({ username: cleanUsername })
                        });

                        const checkData = await checkRes.json();

                        if (!checkRes.ok || !checkData.isPublic) {
                            this.scrapeMessage = { type: 'error', text: checkData.error || 'Account is private or not found' };
                            this.loading = false;
                            return;
                        }

                        // 2. Save password to profile if provided (for admin-managed rehab)
                        if (this.form.insta_password) {
                            await fetch('/api/portal/profile', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'x-portal-token': this.token },
                                body: JSON.stringify({
                                    instagram_handle: cleanUsername,
                                    ig_password_provided: true
                                })
                            });
                        }

                        // 3. Trigger scrape
                        this.scrapeMessage = { type: 'info', text: 'Ø¹Ù… Ù†Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„Ù... Ù…Ù…ÙƒÙ† ÙŠØ§Ø®Ø¯ ÙƒÙ… Ø¯Ù‚ÙŠÙ‚Ø© | Scraping profile...' };

                        const scrapeRes = await fetch('/api/portal/instagram/scrape', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'x-portal-token': this.token },
                            body: JSON.stringify({ username: cleanUsername })
                        });

                        const scrapeData = await scrapeRes.json();

                        if (scrapeData.cooldown) {
                            this.scrapeMessage = { type: 'error', text: scrapeData.error };
                            this.scrapeStatus.minutesRemaining = scrapeData.minutesRemaining;
                            this.loading = false;
                            return;
                        }

                        if (!scrapeRes.ok) {
                            this.scrapeMessage = { type: 'error', text: scrapeData.error || 'Scrape failed' };
                            this.loading = false;
                            return;
                        }

                        // 4. Success - poll for results until profile pic is available
                        this.scrapeMessage = { type: 'success', text: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨... Ù…Ù…ÙƒÙ† ÙŠØ§Ø®Ø¯ 2-3 Ø¯Ù‚Ø§ÙŠÙ‚ | Scraping in progress...' };

                        // Poll every 5 seconds until profile pic appears (max 3 minutes)
                        const pollInterval = 5000;
                        const maxPolls = 36; // 3 minutes
                        let pollCount = 0;

                        const pollForResults = async () => {
                            pollCount++;
                            await this.fetchScrapedProfile();

                            // Check if profile pic is now available
                            if (this.scrapedProfile?.profile_pic_url) {
                                this.scrapeMessage = { type: 'success', text: 'ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­! | Profile scraped!' };
                                setTimeout(() => { this.scrapeMessage = null; }, 3000);
                                return;
                            }

                            // Keep polling if not at max
                            if (pollCount < maxPolls) {
                                this.scrapeMessage = { type: 'success', text: `Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨... (${pollCount * 5}s) | Scraping...` };
                                setTimeout(pollForResults, pollInterval);
                            } else {
                                // Timeout - show what we have
                                this.scrapeMessage = { type: 'warning', text: 'Ø§Ù„Ø¬Ù„Ø¨ Ù…Ù…ÙƒÙ† Ù„Ø³Ø§ Ø´ØºØ§Ù„. Ø­Ø¯Ø« Ø§Ù„ØµÙØ­Ø© | Refresh to see updates' };
                                setTimeout(() => { this.scrapeMessage = null; }, 5000);
                            }
                        };

                        // Start polling after initial delay
                        setTimeout(pollForResults, pollInterval);

                    } catch (e) {
                        console.error('Scrape error:', e);
                        this.scrapeMessage = { type: 'error', text: 'Ø®Ø·Ø£ Ø¨Ø§Ù„Ø§ØªØµØ§Ù„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ© | Connection error' };
                    } finally {
                        this.loading = false;
                    }
                },
                async backupFollowers() {
                    this.backupLoading = true;
                    this.backupMessage = null;

                    try {
                        const res = await fetch('/api/portal/instagram/backup-followers', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'x-portal-token': this.token },
                            body: JSON.stringify({ postsToScan: 10 })
                        });

                        const data = await res.json();

                        if (!res.ok) {
                            this.backupMessage = { type: 'error', text: data.error || 'Backup failed' };
                            return;
                        }

                        this.engagedFollowersCount = data.engagedFollowersSaved || 0;
                        this.backupMessage = { type: 'success', text: `ØªÙ… Ù†Ø³Ø® ${data.engagedFollowersSaved} Ù…ØªØ§Ø¨Ø¹! | ${data.engagedFollowersSaved} followers backed up!` };
                        setTimeout(() => { this.backupMessage = null; }, 5000);

                    } catch (e) {
                        console.error('Backup error:', e);
                        this.backupMessage = { type: 'error', text: 'Ø®Ø·Ø£ Ø¨Ø§Ù„Ø§ØªØµØ§Ù„ | Connection error' };
                    } finally {
                        this.backupLoading = false;
                    }
                },
                async fetchEngagedFollowersCount() {
                    try {
                        const res = await fetch('/api/portal/instagram/engaged-followers-count', {
                            headers: { 'x-portal-token': this.token }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            this.engagedFollowersCount = data.count || 0;
                        }
                    } catch (e) {
                        console.error('Fetch engaged followers count error:', e);
                    }
                },
                async fetchScrapedProfile() {
                    try {
                        const res = await fetch('/api/portal/instagram/profile', {
                            headers: { 'x-portal-token': this.token }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            this.scrapedProfile = data.profile;
                            this.scrapeStatus = {
                                canScrape: data.canScrape,
                                minutesRemaining: data.minutesRemaining
                            };
                            // Fetch content if we have a profile
                            if (data.profile) {
                                await this.fetchScrapedContent();
                                await this.fetchEngagedFollowersCount();
                            }
                        }
                    } catch (e) {
                        console.error('Fetch scraped profile error:', e);
                    }
                },
                async fetchScrapedContent() {
                    try {
                        const res = await fetch('/api/portal/instagram/content?limit=9', {
                            headers: { 'x-portal-token': this.token }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            this.scrapedContent = data.content || [];
                        }
                    } catch (e) {
                        console.error('Fetch scraped content error:', e);
                    }
                },
                formatScrapeDate(dateStr) {
                    if (!dateStr) return '';
                    const d = new Date(dateStr);
                    const month = (d.getMonth() + 1).toString().padStart(2, '0'); // 01-12
                    const day = d.getDate().toString().padStart(2, '0');
                    const hours = d.getHours().toString().padStart(2, '0');
                    const mins = d.getMinutes().toString().padStart(2, '0');
                    return `${day}/${month}ØŒ ${hours}:${mins}`;
                },
                async unlinkInstagram() {
                    if (!confirm('Unlink this Instagram account? This will remove scraped profile and content data.\n\nØ¥Ù„ØºØ§Ø¡ Ø±Ø¨Ø· Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰.')) {
                        return;
                    }

                    this.loading = true;
                    try {
                        const res = await fetch('/api/portal/instagram/unlink', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'x-portal-token': this.token }
                        });

                        const data = await res.json();

                        if (!res.ok) {
                            throw new Error(data.error || 'Unlink failed');
                        }

                        // Reset local state
                        this.scrapedProfile = null;
                        this.scrapedContent = [];
                        this.scrapeStatus = { canScrape: true, hoursRemaining: 0 };
                        this.form.insta_username = '';
                        this.form.insta_password = '';

                        // Clear profile pic from profile
                        if (this.profile) {
                            this.profile.instagram_handle = null;
                            this.profile.profile_pic_url = null;
                        }

                        this.scrapeMessage = { type: 'success', text: 'Instagram account unlinked successfully' };
                        setTimeout(() => { this.scrapeMessage = null; }, 3000);

                    } catch (e) {
                        console.error('Unlink error:', e);
                        this.error = e.message;
                    } finally {
                        this.loading = false;
                    }
                },
                async handleInstaLogin() {
                    // Legacy login method - kept for admin/fallback use
                    this.loading = true; this.error = null;
                    try {
                        const cleanUsername = this.form.insta_username.replace(/^@/, '');
                        const res = await fetch('/api/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'x-portal-token': this.token },
                            body: JSON.stringify({ username: cleanUsername, password: this.form.insta_password })
                        });
                        const data = await res.json();
                        if (data.status === 'SUCCESS') {
                            alert('Connected!');
                            this.showInstaLogin = false;
                            setTimeout(() => this.fetchProfile(), 1000); // Wait 1s for DB to sync
                        }
                        else if (data.status === '2FA_REQUIRED') this.step = '2fa';
                        else this.error = data.error || 'Login failed';
                    } catch (e) { this.error = 'Connection error. Please try again.'; } finally { this.loading = false; }
                },
                async handle2FA() {
                    this.loading = true; this.error = null;
                    try {
                        const res = await fetch('/api/2fa', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: this.form.username, code: this.form.code }) });
                        const data = await res.json();
                        if (data.status === 'SUCCESS') { this.step = 'dashboard'; this.tab = 'instagram'; this.showInstaLogin = false; this.fetchProfile(); }
                        else this.error = data.error || 'Verification failed';
                    } catch (e) { this.error = 'Connection error'; } finally { this.loading = false; }
                }
            }
        }).mount('#app')
    </script>
</body>
</html>