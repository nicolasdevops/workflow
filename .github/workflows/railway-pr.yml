name: Deploy Branch to Railway
on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches:
      - main
      - 'gemini/**'
      - 'jules/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Railway CLI
        run: npm i -g @railway/cli

      - name: Deploy to Railway
        env:
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
        run: |
          unset RAILWAY_TOKEN
          PROJECT_ID="7a92338c-d15a-4448-b1f6-7f1a229e7b8f"
          SERVICE_ID="27617f46-74e7-4bdb-939e-9d3779e7df76"
          
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "Targeting Production Environment"
            railway up --project $PROJECT_ID --service $SERVICE_ID --environment production --detach
          elif [[ "${{ github.ref_name }}" == gemini/* ]]; then
            echo "Targeting Gemini Sandbox"
            railway up --project $PROJECT_ID --service $SERVICE_ID --environment gemini-fix --detach
          else
            echo "Targeting Jules Sandbox"
            railway up --project $PROJECT_ID --service $SERVICE_ID --environment Jules1 --detach
          fi
